{% extends 'base.html' %}
{% block title %}Dashboard - SatyaSetu{% endblock %}

{% block extra_head %}
<style>
    .modal-backdrop { background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); }
    .modal-enter { animation: modalIn 0.3s ease-out forwards; }
    @keyframes modalIn { from { opacity:0; transform:scale(0.95) translateY(20px); } to { opacity:1; transform:scale(1) translateY(0); } }
    .tab-active { border-bottom: 2px solid #6366f1; color: #fff; }
    .tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
    .tab-inactive:hover { color: #94a3b8; }
    .signal-bar { transition: width 0.8s cubic-bezier(0.4,0,0.2,1); }
    .gauge-fill { transition: stroke-dashoffset 1s ease-out; }
    .row-clickable { cursor: pointer; transition: all 0.2s; }
    .row-clickable:hover { background: rgba(255,255,255,0.08) !important; }
    .alert-clickable { cursor: pointer; transition: all 0.2s; }
    .alert-clickable:hover { transform: translateX(4px); }
    .indicator-pill { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 9999px; font-size: 0.7rem; font-weight: 500; }
    .score-ring { filter: drop-shadow(0 0 6px currentColor); }
    .section-divider { height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent); }

    /* ── Verification Flowchart ── */
    .fc-container {
        margin-top: 16px;
        border: 1px solid rgba(99,102,241,0.15);
        border-radius: 16px;
        padding: 24px;
        background: rgba(99,102,241,0.03);
        position: relative;
        overflow: hidden;
    }
    .fc-container::before {
        content: '';
        position: absolute; inset: 0;
        background: radial-gradient(ellipse at 50% 0%, rgba(99,102,241,0.06) 0%, transparent 65%);
        pointer-events: none;
    }
    .fc-header {
        display: flex; align-items: center; gap: 10px; margin-bottom: 20px;
        position: relative; z-index: 1;
    }
    .fc-header-icon {
        width: 34px; height: 34px; border-radius: 10px;
        background: rgba(99,102,241,0.12);
        display: flex; align-items: center; justify-content: center;
        color: #818cf8; font-size: 15px;
    }
    .fc-flow {
        position: relative; z-index: 1;
    }
    /* Each step row */
    .fc-step {
        display: flex; align-items: stretch; gap: 0; position: relative;
    }
    /* Timeline spine */
    .fc-timeline {
        width: 36px; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; position: relative;
    }
    .fc-node {
        width: 14px; height: 14px; border-radius: 50%; border: 2px solid rgba(99,102,241,0.35);
        background: rgba(2,6,23,0.9); position: relative; z-index: 2; flex-shrink: 0;
        transform: scale(0); transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1), border-color 0.4s, box-shadow 0.4s;
    }
    .fc-node.active { transform: scale(1); border-color: #818cf8; box-shadow: 0 0 12px rgba(99,102,241,0.35); }
    .fc-node.done { background: #6366f1; border-color: #818cf8; }
    .fc-node-inner { width: 6px; height: 6px; border-radius: 50%; background: #818cf8; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); opacity: 0; transition: opacity 0.3s 0.15s; }
    .fc-node.done .fc-node-inner { opacity: 1; }
    /* Animated connector line between nodes */
    .fc-connector {
        width: 2px; flex: 1; min-height: 20px; position: relative; overflow: hidden;
    }
    .fc-connector-track { width: 100%; height: 100%; background: rgba(255,255,255,0.06); }
    .fc-connector-fill {
        position: absolute; top: 0; left: 0; width: 100%; height: 0%;
        background: linear-gradient(180deg, #6366f1, #818cf8);
        transition: height 0.6s cubic-bezier(0.16,1,0.3,1);
        border-radius: 1px;
    }
    .fc-connector-fill.live { height: 100%; }
    /* Traveling dot */
    .fc-connector-fill::after {
        content: '';
        position: absolute; bottom: 0; left: 50%; transform: translateX(-50%);
        width: 6px; height: 6px; border-radius: 50%;
        background: #a5b4fc; box-shadow: 0 0 8px rgba(99,102,241,0.6);
        opacity: 0;
    }
    .fc-connector-fill.live::after {
        animation: travelDown 0.8s ease-out 0.1s forwards;
    }
    @keyframes travelDown {
        0% { opacity:1; bottom: 100%; }
        80% { opacity:1; }
        100% { opacity:0; bottom: -4px; }
    }
    /* Card */
    .fc-card {
        flex: 1; min-width: 0;
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 12px;
        padding: 14px 16px;
        background: rgba(255,255,255,0.02);
        opacity: 0;
        transform: translateX(-16px);
        transition: all 0.55s cubic-bezier(0.16, 1, 0.3, 1);
        margin: 4px 0;
    }
    .fc-card.visible {
        opacity: 1;
        transform: translateX(0);
    }
    .fc-card:hover {
        border-color: rgba(99,102,241,0.2);
        background: rgba(255,255,255,0.04);
    }
    /* Horizontal arrow from timeline to card */
    .fc-arm {
        width: 20px; display: flex; align-items: center; position: relative;
    }
    .fc-arm-line {
        width: 0; height: 2px; background: linear-gradient(90deg, #6366f1, #818cf8);
        transition: width 0.35s cubic-bezier(0.16,1,0.3,1); border-radius: 1px;
    }
    .fc-arm-line.live { width: 100%; }
    .fc-arm-arrow {
        position: absolute; right: -1px; top: 50%; transform: translateY(-50%);
        width: 0; height: 0;
        border-top: 4px solid transparent; border-bottom: 4px solid transparent;
        border-left: 5px solid #818cf8;
        opacity: 0; transition: opacity 0.2s ease 0.3s;
    }
    .fc-arm-arrow.live { opacity: 1; }
    /* Status badges */
    .fc-status {
        width: 22px; height: 22px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        flex-shrink: 0;
    }
    .fc-status-ok { background: rgba(16,185,129,0.15); color: #34d399; }
    .fc-status-warn { background: rgba(245,158,11,0.15); color: #fbbf24; }
    .fc-status-err { background: rgba(239,68,68,0.15); color: #f87171; }
    .fc-status-info { background: rgba(99,102,241,0.15); color: #818cf8; }
    /* Verdict card */
    .fc-verdict {
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: 12px;
        padding: 16px 18px;
        background: rgba(255,255,255,0.02);
        opacity: 0;
        transform: translateY(14px);
        transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        position: relative;
    }
    .fc-verdict.visible { opacity: 1; transform: translateY(0); }
    .fc-verdict::before {
        content: '';
        position: absolute; inset: -1px; border-radius: inherit; padding: 1px;
        background: linear-gradient(135deg, rgba(99,102,241,0.25), transparent 60%);
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor; mask-composite: exclude;
        pointer-events: none;
    }
    .fc-src-link {
        color: #818cf8;
        font-size: 11px;
        display: flex;
        align-items: center;
        gap: 3px;
        text-decoration: none;
        transition: color 0.2s;
    }
    .fc-src-link:hover { color: #a5b4fc; }
    /* Step number  */
    .fc-step-num {
        display: inline-flex; align-items: center; justify-content: center;
        width: 18px; height: 18px; border-radius: 5px;
        background: rgba(99,102,241,0.1); color: #818cf8;
        font-size: 10px; font-weight: 700; flex-shrink: 0;
    }

    /* ── Forecast Feature ── */
    .forecast-container {
        margin-top: 16px;
        border: 1.5px dashed rgba(99,102,241,0.2);
        border-radius: 14px;
        padding: 20px;
        background: rgba(99,102,241,0.03);
    }
    .forecast-header {
        display: flex; align-items: center; gap: 10px; margin-bottom: 16px;
    }
    .forecast-header .fc-icon {
        width: 32px; height: 32px; border-radius: 8px;
        background: rgba(99,102,241,0.12);
        display: flex; align-items: center; justify-content: center;
        color: #818cf8; font-size: 16px;
    }
    .forecast-scenario {
        border: 1px solid rgba(255,255,255,0.06);
        border-radius: 10px;
        padding: 14px;
        margin-bottom: 10px;
        background: rgba(255,255,255,0.02);
        transition: border-color 0.2s, background 0.2s;
        opacity: 0; transform: translateX(-12px);
        animation: scenarioSlide 0.4s ease forwards;
    }
    .forecast-scenario:hover {
        border-color: rgba(255,255,255,0.12);
        background: rgba(255,255,255,0.04);
    }
    @keyframes scenarioSlide {
        to { opacity: 1; transform: translateX(0); }
    }
    .forecast-prob-bar {
        height: 6px; border-radius: 3px; background: rgba(255,255,255,0.06);
        overflow: hidden; margin-top: 8px;
    }
    .forecast-prob-fill {
        height: 100%; border-radius: 3px;
        transition: width 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .forecast-loading {
        display: flex; flex-direction: column; align-items: center; gap: 12px;
        padding: 32px 0;
    }
    .forecast-loading .spinner {
        width: 28px; height: 28px;
        border: 2.5px solid rgba(99,102,241,0.15);
        border-top-color: #818cf8;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Page & Section Entrance Animations ── */
    .page-title { opacity: 0; transform: translateY(20px); animation: enterUp 0.8s cubic-bezier(0.16,1,0.3,1) 0.1s forwards; }
    .page-subtitle { opacity: 0; transform: translateY(15px); animation: enterUp 0.8s cubic-bezier(0.16,1,0.3,1) 0.3s forwards; }
    @keyframes enterUp { to { opacity: 1; transform: translateY(0); } }

    .stats-grid > div { opacity: 0; transform: translateY(24px) scale(0.96); animation: cardSlide 0.7s cubic-bezier(0.16,1,0.3,1) forwards; position: relative; overflow: hidden; transition: all 0.45s cubic-bezier(0.4,0,0.2,1); }
    .stats-grid > div:nth-child(1) { animation-delay: 0.2s; }
    .stats-grid > div:nth-child(2) { animation-delay: 0.3s; }
    .stats-grid > div:nth-child(3) { animation-delay: 0.4s; }
    .stats-grid > div:nth-child(4) { animation-delay: 0.5s; }
    @keyframes cardSlide { to { opacity: 1; transform: translateY(0) scale(1); } }
    .stats-grid > div::after { content: ''; position: absolute; inset: 0; border-radius: inherit; opacity: 0; transition: opacity 0.5s; background: radial-gradient(circle at 50% 0%, rgba(99,102,241,0.1), transparent 70%); pointer-events: none; }
    .stats-grid > div:hover { transform: translateY(-6px) scale(1.02) !important; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.4), 0 0 40px rgba(99,102,241,0.06); }
    .stats-grid > div:hover::after { opacity: 1; }

    .reveal-section { opacity: 0; transform: translateY(40px); transition: opacity 0.9s cubic-bezier(0.16,1,0.3,1), transform 0.9s cubic-bezier(0.16,1,0.3,1); }
    .reveal-section.revealed { opacity: 1; transform: translateY(0); }

    .nav-scrolled { background: rgba(2,6,23,0.97) !important; border-bottom-color: rgba(99,102,241,0.12) !important; box-shadow: 0 4px 30px rgba(0,0,0,0.35), 0 0 60px rgba(99,102,241,0.03); }

    .glass-card { transition: all 0.35s cubic-bezier(0.4,0,0.2,1); }
    .glass-card:hover { border-color: rgba(255,255,255,0.1); transform: translateY(-2px); box-shadow: 0 12px 30px -8px rgba(0,0,0,0.3); }
</style>
{% endblock %}

{% block content %}
<canvas id="particleBg" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;"></canvas>

<!-- Dashboard Navigation -->
<nav id="mainNav" class="fixed top-0 left-0 right-0 z-50 glass bg-dark-950/90 backdrop-blur-xl border-b border-white/5 transition-all duration-300">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <a href="/" class="flex items-center gap-3 group">
                <div class="relative">
                    <div class="absolute inset-0 bg-gradient-to-br from-indigo-500 to-cyan-400 rounded-lg blur-md opacity-50 group-hover:opacity-75 transition-opacity"></div>
                    <div class="relative w-9 h-9 rounded-lg bg-gradient-to-br from-indigo-500 to-cyan-400 flex items-center justify-center group-hover:scale-105 transition-transform">
                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                        </svg>
                    </div>
                </div>
                <span class="text-lg font-bold text-white tracking-tight">SatyaSetu</span>
            </a>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3">
                    {% if user_avatar %}
                    <img src="{{ user_avatar }}" alt="Avatar" class="w-8 h-8 rounded-full ring-2 ring-indigo-500/30">
                    {% else %}
                    <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-violet-500 flex items-center justify-center text-sm font-bold text-white">{{ user_initial }}</div>
                    {% endif %}
                    <span class="hidden sm:block text-sm font-medium text-dark-300">{{ user_email }}</span>
                </div>
                <button onclick="handleLogout()" class="px-4 py-2 rounded-lg text-sm font-medium text-dark-400 hover:text-white hover:bg-white/5 transition-all">Sign Out</button>
            </div>
        </div>
    </div>
</nav>

<!-- Main Content -->
<main class="pt-24 pb-16 min-h-screen relative">
    <div class="absolute inset-0 mesh-gradient opacity-30"></div>
    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">

        <!-- Welcome Header -->
        <div class="mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-white mb-2 page-title">Welcome back, <span class="text-indigo-400">{{ user_name }}</span></h1>
            <p class="text-dark-400 text-sm page-subtitle">Misinformation Intelligence Command Center</p>
        </div>

        <!-- ═══════════ SECTION 1: Stats Overview ═══════════ -->
        <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8 stats-grid">
            <div class="glass rounded-2xl p-5 card-hover">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 rounded-xl bg-indigo-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                    </div>
                </div>
                <div class="text-2xl font-bold text-white">{{ sources_count }}</div>
                <div class="text-xs text-dark-400 mt-1">Sources Monitored</div>
            </div>
            <div class="glass rounded-2xl p-5 card-hover">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 rounded-xl bg-rose-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>
                    </div>
                    <span class="text-xs font-medium text-rose-400 bg-rose-500/10 px-2 py-0.5 rounded-lg">7d</span>
                </div>
                <div class="text-2xl font-bold text-white">{{ threats_count }}</div>
                <div class="text-xs text-dark-400 mt-1">Threats Detected</div>
            </div>
            <div class="glass rounded-2xl p-5 card-hover">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 rounded-xl bg-amber-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                    </div>
                    <span class="text-xs font-medium {% if avg_risk > 7 %}text-rose-400 bg-rose-500/10{% elif avg_risk > 4 %}text-amber-400 bg-amber-500/10{% else %}text-emerald-400 bg-emerald-500/10{% endif %} px-2 py-0.5 rounded-lg">{% if avg_risk > 7 %}High{% elif avg_risk > 4 %}Med{% else %}Low{% endif %}</span>
                </div>
                <div class="text-2xl font-bold text-white">{{ avg_risk }}<span class="text-sm text-dark-500 font-normal">/10</span></div>
                <div class="text-xs text-dark-400 mt-1">Avg Risk Score</div>
            </div>
            <div class="glass rounded-2xl p-5 card-hover">
                <div class="flex items-center justify-between mb-3">
                    <div class="w-10 h-10 rounded-xl bg-emerald-500/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    </div>
                </div>
                <div class="text-2xl font-bold text-white">{{ accuracy_rate|floatformat:1 }}%</div>
                <div class="text-xs text-dark-400 mt-1">System Accuracy</div>
            </div>
        </div>

        <!-- ═══════════ SECTION 2: Content Analyzer (Tabbed: Text / Image / Audio) ═══════════ -->
        <div class="glass rounded-2xl p-6 mb-8 reveal-section">
            <div class="flex items-center justify-between mb-5">
                <div>
                    <h2 class="text-lg font-bold text-white">Analyze Content</h2>
                    <p class="text-xs text-dark-500 mt-0.5">Analyze text, images, or audio for misinformation</p>
                </div>
                <div class="flex items-center gap-2">
                    <span class="px-2.5 py-1 rounded-lg bg-indigo-500/10 text-indigo-400 text-xs font-medium flex items-center gap-1.5">
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>
                        AI Detection Active
                    </span>
                </div>
            </div>

            <!-- Analysis Mode Tabs -->
            <div class="flex gap-1 mb-5 p-1 bg-white/5 rounded-xl w-fit">
                <button onclick="switchAnalysisTab('text')" id="tabText" class="px-4 py-2 rounded-lg text-sm font-medium transition-all bg-indigo-500/20 text-indigo-400">
                    <span class="flex items-center gap-1.5">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Text
                    </span>
                </button>
                <button onclick="switchAnalysisTab('image')" id="tabImage" class="px-4 py-2 rounded-lg text-sm font-medium transition-all text-dark-500 hover:text-dark-300">
                    <span class="flex items-center gap-1.5">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        Image
                    </span>
                </button>
                <button onclick="switchAnalysisTab('audio')" id="tabAudio" class="px-4 py-2 rounded-lg text-sm font-medium transition-all text-dark-500 hover:text-dark-300">
                    <span class="flex items-center gap-1.5">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                        Audio
                    </span>
                </button>
            </div>

            <!-- TEXT Analysis Panel -->
            <div id="panelText" class="analysis-panel">
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-dark-400 mb-1.5">Content Title</label>
                        <input type="text" id="contentTitle" placeholder="Enter article title..." class="w-full px-4 py-2.5 rounded-lg bg-white/5 border border-white/10 text-white text-sm placeholder-dark-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-dark-400 mb-1.5">Source URL <span class="text-dark-600">(optional)</span></label>
                        <input type="text" id="contentUrl" placeholder="https://..." class="w-full px-4 py-2.5 rounded-lg bg-white/5 border border-white/10 text-white text-sm placeholder-dark-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-dark-400 mb-1.5">Content Text</label>
                        <textarea id="contentText" rows="3" placeholder="Paste the article content here..." class="w-full px-4 py-2.5 rounded-lg bg-white/5 border border-white/10 text-white text-sm placeholder-dark-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all resize-none"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <button id="analyzeBtn" onclick="analyzeContent()" class="w-full px-6 py-3 rounded-lg bg-gradient-to-r from-indigo-600 to-violet-600 hover:from-indigo-500 hover:to-violet-500 text-white font-medium text-sm transition-all shadow-lg shadow-indigo-500/20 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                            Analyze Content
                        </button>
                    </div>
                </div>
            </div>

            <!-- IMAGE Analysis Panel -->
            <div id="panelImage" class="analysis-panel hidden">
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-dark-400 mb-1.5">Title <span class="text-dark-600">(optional)</span></label>
                        <input type="text" id="imageTitle" placeholder="Describe the image content..." class="w-full px-4 py-2.5 rounded-lg bg-white/5 border border-white/10 text-white text-sm placeholder-dark-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-dark-400 mb-1.5">Upload Image / Screenshot</label>
                        <div id="imageDropZone" class="relative w-full border-2 border-dashed border-white/10 rounded-xl p-8 text-center hover:border-indigo-500/50 transition-all cursor-pointer group" onclick="document.getElementById('imageFileInput').click()" ondrop="handleImageDrop(event)" ondragover="event.preventDefault(); this.classList.add('border-indigo-500/50', 'bg-indigo-500/5')" ondragleave="this.classList.remove('border-indigo-500/50', 'bg-indigo-500/5')">
                            <input type="file" id="imageFileInput" accept="image/*" class="hidden" onchange="handleImageSelect(this)">
                            <div id="imagePreviewArea">
                                <svg class="w-10 h-10 mx-auto mb-3 text-dark-600 group-hover:text-indigo-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                                <p class="text-sm text-dark-400 group-hover:text-dark-300 transition-colors">Drop an image here or <span class="text-indigo-400">click to browse</span></p>
                                <p class="text-xs text-dark-600 mt-1">PNG, JPG, BMP, TIFF, WebP — max 25MB</p>
                            </div>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <button id="analyzeImageBtn" onclick="analyzeImage()" disabled class="w-full px-6 py-3 rounded-lg bg-gradient-to-r from-violet-600 to-purple-600 hover:from-violet-500 hover:to-purple-500 disabled:opacity-40 disabled:cursor-not-allowed text-white font-medium text-sm transition-all shadow-lg shadow-violet-500/20 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                            Extract Text &amp; Analyze Image
                        </button>
                    </div>
                </div>
            </div>

            <!-- AUDIO Analysis Panel -->
            <div id="panelAudio" class="analysis-panel hidden">
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-dark-400 mb-1.5">Title <span class="text-dark-600">(optional)</span></label>
                        <input type="text" id="audioTitle" placeholder="Describe the audio content..." class="w-full px-4 py-2.5 rounded-lg bg-white/5 border border-white/10 text-white text-sm placeholder-dark-600 focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-all">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-dark-400 mb-1.5">Upload or Record Audio</label>
                        <!-- Audio source toggle -->
                        <div class="flex gap-2 mb-3">
                            <button onclick="showAudioMode('upload')" id="audioModeUpload" class="flex-1 px-3 py-2 rounded-lg text-xs font-medium transition-all bg-cyan-500/15 text-cyan-400 border border-cyan-500/20 flex items-center justify-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
                                Upload File
                            </button>
                            <button onclick="showAudioMode('record')" id="audioModeRecord" class="flex-1 px-3 py-2 rounded-lg text-xs font-medium transition-all text-dark-500 hover:text-dark-300 border border-white/5 flex items-center justify-center gap-1.5">
                                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                                Record Mic
                            </button>
                        </div>
                        <!-- Upload mode -->
                        <div id="audioUploadMode">
                            <div id="audioDropZone" class="relative w-full border-2 border-dashed border-white/10 rounded-xl p-8 text-center hover:border-cyan-500/50 transition-all cursor-pointer group" onclick="document.getElementById('audioFileInput').click()" ondrop="handleAudioDrop(event)" ondragover="event.preventDefault(); this.classList.add('border-cyan-500/50', 'bg-cyan-500/5')" ondragleave="this.classList.remove('border-cyan-500/50', 'bg-cyan-500/5')">
                                <input type="file" id="audioFileInput" accept="audio/*,.wav,.mp3,.ogg,.flac,.m4a,.wma,.aac,.webm" class="hidden" onchange="handleAudioSelect(this)">
                                <div id="audioPreviewArea">
                                    <svg class="w-10 h-10 mx-auto mb-3 text-dark-600 group-hover:text-cyan-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                                    <p class="text-sm text-dark-400 group-hover:text-dark-300 transition-colors">Drop an audio file here or <span class="text-cyan-400">click to browse</span></p>
                                    <p class="text-xs text-dark-600 mt-1">WAV, MP3, OGG, FLAC, M4A, WebM — max 25MB</p>
                                </div>
                            </div>
                        </div>
                        <!-- Record mode -->
                        <div id="audioRecordMode" class="hidden">
                            <div class="w-full border-2 border-dashed border-white/10 rounded-xl p-8 text-center transition-all" id="recordZone">
                                <div id="recordUI">
                                    <!-- Idle state -->
                                    <div id="recordIdle">
                                        <button onclick="startRecording()" class="w-20 h-20 mx-auto rounded-full bg-gradient-to-br from-rose-500 to-pink-600 hover:from-rose-400 hover:to-pink-500 shadow-lg shadow-rose-500/30 flex items-center justify-center transition-all hover:scale-105 active:scale-95">
                                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                                        </button>
                                        <p class="text-sm text-dark-400 mt-3">Click to start recording</p>
                                        <p class="text-xs text-dark-600 mt-1">Uses your microphone · max 5 minutes</p>
                                    </div>
                                    <!-- Recording state -->
                                    <div id="recordActive" class="hidden">
                                        <div class="flex flex-col items-center gap-3">
                                            <div class="relative">
                                                <div class="w-20 h-20 rounded-full bg-rose-500/20 flex items-center justify-center animate-pulse">
                                                    <div class="w-14 h-14 rounded-full bg-rose-500/30 flex items-center justify-center">
                                                        <div class="w-5 h-5 rounded-sm bg-white"></div>
                                                    </div>
                                                </div>
                                                <span class="absolute -top-1 -right-1 w-4 h-4 rounded-full bg-rose-500 animate-ping"></span>
                                            </div>
                                            <div class="text-center">
                                                <p class="text-base font-mono text-rose-400 font-bold" id="recordTimer">00:00</p>
                                                <p class="text-xs text-dark-500 mt-0.5">Recording...</p>
                                            </div>
                                            <div class="flex items-center gap-3">
                                                <button onclick="stopRecording()" class="px-5 py-2 rounded-lg bg-rose-500/20 text-rose-400 text-sm font-medium hover:bg-rose-500/30 transition-all flex items-center gap-1.5">
                                                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
                                                    Stop
                                                </button>
                                                <button onclick="cancelRecording()" class="px-4 py-2 rounded-lg text-dark-500 text-sm hover:text-dark-300 transition-all">Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Recorded preview -->
                                    <div id="recordPreview" class="hidden"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <button id="analyzeAudioBtn" onclick="analyzeAudio()" disabled class="w-full px-6 py-3 rounded-lg bg-gradient-to-r from-cyan-600 to-teal-600 hover:from-cyan-500 hover:to-teal-500 disabled:opacity-40 disabled:cursor-not-allowed text-white font-medium text-sm transition-all shadow-lg shadow-cyan-500/20 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                            Transcribe &amp; Analyze Audio
                        </button>
                    </div>
                </div>
            </div>

            <!-- Inline Analysis Result (shows after analysis - shared across all tabs) -->
            <div id="analysisResult" class="hidden"></div>
        </div>

        <!-- ═══════════ SECTION 2.5: News Intelligence Feed ═══════════ -->
        <div class="glass rounded-2xl p-6 mb-8 reveal-section">
            <div class="flex items-center justify-between mb-5">
                <div>
                    <h2 class="text-lg font-bold text-white flex items-center gap-2">
                        <svg class="w-5 h-5 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
                        News Intelligence Feed
                    </h2>
                    <p class="text-xs text-dark-500 mt-0.5">Fetch live news, auto-analyze with AI, and see which sources were scraped</p>
                </div>
                <div class="flex items-center gap-3">
                    <select id="newsCategory" class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-dark-300 text-sm focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500">
                        <option value="">Top Headlines</option>
                        <option value="technology">Technology</option>
                        <option value="business">Business</option>
                        <option value="health">Health</option>
                        <option value="science">Science</option>
                        <option value="sports">Sports</option>
                        <option value="entertainment">Entertainment</option>
                    </select>
                    <div class="flex items-center gap-2">
                        <input type="text" id="newsQuery" placeholder="Search news..." class="px-3 py-2 rounded-lg bg-white/5 border border-white/10 text-white text-sm placeholder-dark-600 focus:border-cyan-500 focus:ring-1 focus:ring-cyan-500 w-40">
                        <button id="fetchNewsBtn" onclick="fetchNewsFeed(this)" class="px-4 py-2 rounded-lg bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white text-sm font-medium transition-all flex items-center gap-2 shadow-lg shadow-cyan-500/20">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            Fetch &amp; Analyze
                        </button>
                    </div>
                </div>
            </div>

            <!-- News Feed Status -->
            <div id="newsFeedStatus" class="hidden mb-4"></div>

            <!-- News Feed Results -->
            <div id="newsFeedResults" class="space-y-3">
                <div class="text-center py-12 text-dark-500">
                    <svg class="w-12 h-12 mx-auto mb-3 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/></svg>
                    <p class="text-sm">Click "Fetch & Analyze" to load latest news with AI analysis</p>
                    <p class="text-xs text-dark-600 mt-1">Each article is analyzed and verified against real web sources</p>
                </div>
            </div>
        </div>

        <!-- ═══════════ SECTION 3: Intelligence Grid ═══════════ -->
        <div class="grid lg:grid-cols-12 gap-6 mb-8 reveal-section">

            <!-- LEFT: Recent Alerts (clickable) -->
            <div class="lg:col-span-8 glass rounded-2xl p-6">
                <div class="flex items-center justify-between mb-5">
                    <div>
                        <h2 class="text-lg font-bold text-white">Recent Alerts</h2>
                        <p class="text-xs text-dark-500 mt-0.5">Click any alert for full analysis</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="relative flex h-2.5 w-2.5"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-rose-400 opacity-75"></span><span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-rose-500"></span></span>
                        <span class="text-xs text-dark-500">Live</span>
                    </div>
                </div>
                <div class="space-y-3" id="alertsContainer">
                    {% for alert in recent_alerts %}
                    <div class="alert-clickable flex items-start gap-3 p-4 rounded-xl {% if alert.severity == 'critical' %}bg-rose-500/5 border border-rose-500/10{% elif alert.severity == 'warning' %}bg-amber-500/5 border border-amber-500/10{% else %}bg-blue-500/5 border border-blue-500/10{% endif %}" onclick="openAlertDetail({{ alert.id }})">
                        <div class="flex-shrink-0 mt-0.5">
                            {% if alert.severity == 'critical' %}
                            <div class="w-8 h-8 rounded-lg bg-rose-500/10 flex items-center justify-center"><svg class="w-4 h-4 text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg></div>
                            {% elif alert.severity == 'warning' %}
                            <div class="w-8 h-8 rounded-lg bg-amber-500/10 flex items-center justify-center"><svg class="w-4 h-4 text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                            {% else %}
                            <div class="w-8 h-8 rounded-lg bg-blue-500/10 flex items-center justify-center"><svg class="w-4 h-4 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
                            {% endif %}
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-sm font-semibold text-white truncate">{{ alert.title|truncatechars:80 }}</span>
                            </div>
                            <p class="text-xs text-dark-400 line-clamp-2">{{ alert.message|truncatechars:180 }}</p>
                            <div class="flex items-center gap-3 mt-2">
                                <span class="px-2 py-0.5 rounded text-xs font-medium {% if alert.severity == 'critical' %}bg-rose-500/20 text-rose-400{% elif alert.severity == 'warning' %}bg-amber-500/20 text-amber-400{% else %}bg-blue-500/20 text-blue-400{% endif %}">{{ alert.get_severity_display }}</span>
                                <span class="text-xs text-dark-600">{{ alert.created_at|timesince }} ago</span>
                                <span class="text-xs text-dark-600">Impact: {{ alert.analysis.societal_impact_score|floatformat:1 }}/10</span>
                            </div>
                        </div>
                        <svg class="w-4 h-4 text-dark-600 flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                    </div>
                    {% empty %}
                    <div class="text-center py-12 text-dark-500">
                        <svg class="w-10 h-10 mx-auto mb-3 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        <p class="text-sm">No alerts — all clear</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- RIGHT: Threat Level Gauge -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Dynamic Threat Level -->
                <div class="glass rounded-2xl p-6">
                    <h2 class="text-sm font-semibold text-dark-400 uppercase tracking-wider mb-5">Threat Level</h2>
                    <div class="relative w-36 h-36 mx-auto mb-4" id="threatGauge">
                        <svg class="w-full h-full -rotate-90" viewBox="0 0 120 120">
                            <circle cx="60" cy="60" r="50" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="10"/>
                            <circle id="threatArc" cx="60" cy="60" r="50" fill="none" stroke="url(#threatGrad)" stroke-width="10" stroke-linecap="round" stroke-dasharray="314" stroke-dashoffset="314" class="gauge-fill"/>
                            <defs>
                                <linearGradient id="threatGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                                    <stop offset="0%" stop-color="#10b981"/>
                                    <stop offset="50%" stop-color="#f59e0b"/>
                                    <stop offset="100%" stop-color="#ef4444"/>
                                </linearGradient>
                            </defs>
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                            <span class="text-3xl font-bold text-white" id="threatValue">{{ avg_risk }}</span>
                            <span class="text-xs text-dark-500">/10</span>
                        </div>
                    </div>
                    <div class="text-center" id="threatLabel">
                        {% if avg_risk > 7 %}
                        <span class="px-3 py-1 rounded-lg bg-rose-500/10 text-rose-400 text-xs font-semibold">CRITICAL</span>
                        {% elif avg_risk > 4 %}
                        <span class="px-3 py-1 rounded-lg bg-amber-500/10 text-amber-400 text-xs font-semibold">ELEVATED</span>
                        {% else %}
                        <span class="px-3 py-1 rounded-lg bg-emerald-500/10 text-emerald-400 text-xs font-semibold">NORMAL</span>
                        {% endif %}
                    </div>
                    <!-- Threat breakdown -->
                    <div class="mt-5 pt-4 border-t border-white/5 space-y-2">
                        <div class="flex justify-between text-xs">
                            <span class="text-dark-400">High Risk</span>
                            <span class="text-rose-400 font-medium">{{ threats_count }}</span>
                        </div>
                        <div class="flex justify-between text-xs">
                            <span class="text-dark-400">Sources Active</span>
                            <span class="text-indigo-400 font-medium">{{ sources_count }}</span>
                        </div>
                    </div>
                </div>

                <!-- Quick Risk Distribution -->
                <div class="glass rounded-2xl p-6">
                    <h2 class="text-sm font-semibold text-dark-400 uppercase tracking-wider mb-4">Risk Distribution</h2>
                    <div class="space-y-3">
                        {% for analysis in recent_analyses|slice:":5" %}
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 rounded-full flex-shrink-0 {% if analysis.risk_level == 'critical' %}bg-rose-500{% elif analysis.risk_level == 'high' %}bg-amber-500{% elif analysis.risk_level == 'medium' %}bg-blue-500{% else %}bg-emerald-500{% endif %}"></div>
                            <div class="flex-1 min-w-0">
                                <div class="text-xs text-white truncate">{{ analysis.content.title|truncatechars:30 }}</div>
                            </div>
                            <span class="text-xs font-mono {% if analysis.misinformation_likelihood > 0.7 %}text-rose-400{% elif analysis.misinformation_likelihood > 0.4 %}text-amber-400{% else %}text-emerald-400{% endif %}">{% widthratio analysis.misinformation_likelihood 1 100 %}%</span>
                        </div>
                        {% empty %}
                        <p class="text-xs text-dark-600 text-center py-4">No data yet</p>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ═══════════ SECTION 4: Recent Analyses Table ═══════════ -->
        <div class="glass rounded-2xl p-6 reveal-section">
            <div class="flex items-center justify-between mb-5">
                <div>
                    <h2 class="text-lg font-bold text-white">Recent Analyses</h2>
                    <p class="text-xs text-dark-500 mt-0.5">Click any row for complete analysis details</p>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead>
                        <tr class="text-dark-500 border-b border-white/10 text-xs uppercase tracking-wider">
                            <th class="pb-3 font-medium">Content</th>
                            <th class="pb-3 font-medium">Misinfo Score</th>
                            <th class="pb-3 font-medium">Impact</th>
                            <th class="pb-3 font-medium">Risk</th>
                            <th class="pb-3 font-medium">Amplification</th>
                            <th class="pb-3 font-medium">Time</th>
                        </tr>
                    </thead>
                    <tbody class="text-dark-300">
                        {% for analysis in recent_analyses %}
                        <tr class="border-b border-white/5 row-clickable" onclick="openAnalysisDetail({{ analysis.id }})">
                            <td class="py-3.5 pr-4 max-w-xs">
                                <div class="font-medium text-white text-sm truncate">{{ analysis.content.title|truncatechars:55 }}</div>
                                <div class="text-xs text-dark-600 mt-0.5">{{ analysis.content.source.name }}</div>
                            </td>
                            <td class="py-3.5 pr-4">
                                <div class="flex items-center gap-2">
                                    <div class="w-14 bg-white/5 rounded-full h-1.5">
                                        <div class="h-1.5 rounded-full signal-bar {% if analysis.misinformation_likelihood > 0.7 %}bg-rose-500{% elif analysis.misinformation_likelihood > 0.4 %}bg-amber-500{% else %}bg-emerald-500{% endif %}" style="width: {% widthratio analysis.misinformation_likelihood 1 100 %}%"></div>
                                    </div>
                                    <span class="text-xs font-mono font-medium {% if analysis.misinformation_likelihood > 0.7 %}text-rose-400{% elif analysis.misinformation_likelihood > 0.4 %}text-amber-400{% else %}text-emerald-400{% endif %}">{% widthratio analysis.misinformation_likelihood 1 100 %}%</span>
                                </div>
                            </td>
                            <td class="py-3.5 pr-4">
                                <span class="font-medium text-white">{{ analysis.societal_impact_score|floatformat:1 }}</span>
                                <span class="text-xs text-dark-600">/10</span>
                            </td>
                            <td class="py-3.5 pr-4">
                                <span class="px-2 py-0.5 rounded text-xs font-semibold
                                    {% if analysis.risk_level == 'critical' %}bg-rose-500/15 text-rose-400
                                    {% elif analysis.risk_level == 'high' %}bg-amber-500/15 text-amber-400
                                    {% elif analysis.risk_level == 'medium' %}bg-blue-500/15 text-blue-400
                                    {% else %}bg-emerald-500/15 text-emerald-400{% endif %}">
                                    {{ analysis.get_risk_level_display }}
                                </span>
                            </td>
                            <td class="py-3.5 pr-4">
                                <span class="text-xs font-mono">{% widthratio analysis.amplification_risk 1 100 %}%</span>
                            </td>
                            <td class="py-3.5 text-xs text-dark-600 whitespace-nowrap">{{ analysis.analyzed_at|timesince }} ago</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="py-12 text-center text-dark-600 text-sm">No analyses yet. Analyze content or fetch news to get started.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<!-- ═══════════ DETAIL MODAL ═══════════ -->
<div id="detailModal" class="fixed inset-0 z-[100] hidden">
    <div class="modal-backdrop absolute inset-0" onclick="closeModal()"></div>
    <div class="relative z-10 flex items-start justify-center min-h-screen p-4 pt-20">
        <div class="modal-enter w-full max-w-3xl bg-dark-900 rounded-2xl border border-white/10 shadow-2xl overflow-hidden max-h-[80vh] flex flex-col">
            <!-- Modal Header -->
            <div class="flex items-center justify-between p-5 border-b border-white/5 flex-shrink-0" id="modalHeader">
                <div class="flex items-center gap-3 min-w-0">
                    <div id="modalRiskBadge" class="flex-shrink-0"></div>
                    <div class="min-w-0">
                        <h3 class="text-base font-bold text-white truncate" id="modalTitle">Loading...</h3>
                        <p class="text-xs text-dark-500" id="modalMeta"></p>
                    </div>
                </div>
                <button onclick="closeModal()" class="text-dark-500 hover:text-white transition p-1 flex-shrink-0">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <!-- Modal Body (scrollable) -->
            <div class="overflow-y-auto flex-1 p-5" id="modalBody">
                <div class="text-center py-8">
                    <div class="animate-spin w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto"></div>
                    <p class="text-dark-400 text-sm mt-3">Loading analysis...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ──────── Auth ────────
async function handleLogout() {
    try { await supabaseClient.auth.signOut(); } catch(e) {}
    window.location.href = '/accounts/logout/';
}

// ──────── Threat Gauge Animation ────────
document.addEventListener('DOMContentLoaded', () => {
    const arc = document.getElementById('threatArc');
    if (arc) {
        const risk = {{ avg_risk|default:"0" }};
        const pct = Math.min(risk / 10, 1);
        const offset = 314 - (314 * pct);
        setTimeout(() => { arc.style.strokeDashoffset = offset; }, 300);
    }
});

// ──────── Analysis Tab Switching ────────
let currentAnalysisTab = 'text';
let selectedImageFile = null;
let selectedAudioFile = null;

function switchAnalysisTab(tab) {
    currentAnalysisTab = tab;
    // Update tab buttons
    ['text', 'image', 'audio'].forEach(t => {
        const btn = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
        const panel = document.getElementById('panel' + t.charAt(0).toUpperCase() + t.slice(1));
        if (t === tab) {
            btn.className = 'px-4 py-2 rounded-lg text-sm font-medium transition-all bg-indigo-500/20 text-indigo-400';
            panel.classList.remove('hidden');
        } else {
            btn.className = 'px-4 py-2 rounded-lg text-sm font-medium transition-all text-dark-500 hover:text-dark-300';
            panel.classList.add('hidden');
        }
    });
    // Hide previous results when switching tabs
    document.getElementById('analysisResult').className = 'hidden';
}

// ──────── Image Upload Handling ────────
function handleImageSelect(input) {
    if (input.files && input.files[0]) {
        selectedImageFile = input.files[0];
        showImagePreview(selectedImageFile);
        document.getElementById('analyzeImageBtn').disabled = false;
    }
}

function handleImageDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('border-indigo-500/50', 'bg-indigo-500/5');
    const file = event.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
        selectedImageFile = file;
        document.getElementById('imageFileInput').files = event.dataTransfer.files;
        showImagePreview(selectedImageFile);
        document.getElementById('analyzeImageBtn').disabled = false;
    }
}

function showImagePreview(file) {
    const preview = document.getElementById('imagePreviewArea');
    const reader = new FileReader();
    reader.onload = function(e) {
        preview.innerHTML = `
            <div class="flex items-center gap-4">
                <img src="${e.target.result}" class="w-24 h-24 rounded-lg object-cover border border-white/10">
                <div class="text-left">
                    <p class="text-sm text-white font-medium">${file.name}</p>
                    <p class="text-xs text-dark-500">${(file.size / 1024).toFixed(1)} KB · ${file.type}</p>
                    <button onclick="event.stopPropagation(); clearImageFile()" class="text-xs text-rose-400 hover:text-rose-300 mt-1">Remove</button>
                </div>
            </div>`;
    };
    reader.readAsDataURL(file);
}

function clearImageFile() {
    selectedImageFile = null;
    document.getElementById('imageFileInput').value = '';
    document.getElementById('analyzeImageBtn').disabled = true;
    document.getElementById('imagePreviewArea').innerHTML = `
        <svg class="w-10 h-10 mx-auto mb-3 text-dark-600 group-hover:text-indigo-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
        <p class="text-sm text-dark-400">Drop an image here or <span class="text-indigo-400">click to browse</span></p>
        <p class="text-xs text-dark-600 mt-1">PNG, JPG, BMP, TIFF, WebP — max 25MB</p>`;
}

// ──────── Audio Mode Toggle ────────
function showAudioMode(mode) {
    const uploadEl = document.getElementById('audioUploadMode');
    const recordEl = document.getElementById('audioRecordMode');
    const btnUpload = document.getElementById('audioModeUpload');
    const btnRecord = document.getElementById('audioModeRecord');
    if (mode === 'upload') {
        uploadEl.classList.remove('hidden');
        recordEl.classList.add('hidden');
        btnUpload.className = 'flex-1 px-3 py-2 rounded-lg text-xs font-medium transition-all bg-cyan-500/15 text-cyan-400 border border-cyan-500/20 flex items-center justify-center gap-1.5';
        btnRecord.className = 'flex-1 px-3 py-2 rounded-lg text-xs font-medium transition-all text-dark-500 hover:text-dark-300 border border-white/5 flex items-center justify-center gap-1.5';
    } else {
        uploadEl.classList.add('hidden');
        recordEl.classList.remove('hidden');
        btnUpload.className = 'flex-1 px-3 py-2 rounded-lg text-xs font-medium transition-all text-dark-500 hover:text-dark-300 border border-white/5 flex items-center justify-center gap-1.5';
        btnRecord.className = 'flex-1 px-3 py-2 rounded-lg text-xs font-medium transition-all bg-cyan-500/15 text-cyan-400 border border-cyan-500/20 flex items-center justify-center gap-1.5';
    }
}

// ──────── Audio Upload Handling ────────
function handleAudioSelect(input) {
    if (input.files && input.files[0]) {
        selectedAudioFile = input.files[0];
        showAudioPreview(selectedAudioFile);
        document.getElementById('analyzeAudioBtn').disabled = false;
    }
}

function handleAudioDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('border-cyan-500/50', 'bg-cyan-500/5');
    const file = event.dataTransfer.files[0];
    if (file && (file.type.startsWith('audio/') || file.name.match(/\.(wav|mp3|ogg|flac|m4a|wma|aac|webm)$/i))) {
        selectedAudioFile = file;
        document.getElementById('audioFileInput').files = event.dataTransfer.files;
        showAudioPreview(selectedAudioFile);
        document.getElementById('analyzeAudioBtn').disabled = false;
    }
}

function showAudioPreview(file) {
    const preview = document.getElementById('audioPreviewArea');
    const audioURL = URL.createObjectURL(file);
    preview.innerHTML = `
        <div class="flex flex-col items-center gap-3">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-xl bg-cyan-500/10 flex items-center justify-center">
                    <svg class="w-6 h-6 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/></svg>
                </div>
                <div class="text-left">
                    <p class="text-sm text-white font-medium">${file.name}</p>
                    <p class="text-xs text-dark-500">${(file.size / 1024).toFixed(1)} KB · ${file.type || 'audio'}</p>
                </div>
                <button onclick="event.stopPropagation(); clearAudioFile()" class="text-xs text-rose-400 hover:text-rose-300 ml-2">Remove</button>
            </div>
            <audio controls src="${audioURL}" class="w-full max-w-md h-8 mt-1" style="filter: invert(1) hue-rotate(180deg) brightness(0.8);"></audio>
        </div>`;
}

function clearAudioFile() {
    selectedAudioFile = null;
    document.getElementById('audioFileInput').value = '';
    document.getElementById('analyzeAudioBtn').disabled = true;
    document.getElementById('audioPreviewArea').innerHTML = `
        <svg class="w-10 h-10 mx-auto mb-3 text-dark-600 group-hover:text-cyan-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
        <p class="text-sm text-dark-400">Drop an audio file here or <span class="text-cyan-400">click to browse</span></p>
        <p class="text-xs text-dark-600 mt-1">WAV, MP3, OGG, FLAC, M4A, WebM — max 25MB</p>`;
}

// ──────── Audio Recording (WAV via AudioContext) ────────
let recordTimerInterval = null;
let recordStartTime = null;
let audioContext = null;
let audioStreamSource = null;
let scriptProcessor = null;
let recordedPCM = [];
let recordStream = null;
const MAX_RECORD_SECONDS = 300; // 5 minutes
const RECORD_SAMPLE_RATE = 16000;

// Encode raw PCM float32 samples into a WAV Blob
function encodeWAV(samples, sampleRate) {
    const buffer = new ArrayBuffer(44 + samples.length * 2);
    const view = new DataView(buffer);
    function writeStr(offset, str) { for (let i = 0; i < str.length; i++) view.setUint8(offset + i, str.charCodeAt(i)); }
    writeStr(0, 'RIFF');
    view.setUint32(4, 36 + samples.length * 2, true);
    writeStr(8, 'WAVE');
    writeStr(12, 'fmt ');
    view.setUint32(16, 16, true);
    view.setUint16(20, 1, true); // PCM
    view.setUint16(22, 1, true); // mono
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, sampleRate * 2, true); // byte rate
    view.setUint16(32, 2, true); // block align
    view.setUint16(34, 16, true); // bits per sample
    writeStr(36, 'data');
    view.setUint32(40, samples.length * 2, true);
    // Convert float32 [-1,1] to int16
    for (let i = 0; i < samples.length; i++) {
        const s = Math.max(-1, Math.min(1, samples[i]));
        view.setInt16(44 + i * 2, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
    }
    return new Blob([view], { type: 'audio/wav' });
}

// Downsample from source rate to target rate
function downsample(buffer, fromRate, toRate) {
    if (fromRate === toRate) return buffer;
    const ratio = fromRate / toRate;
    const len = Math.round(buffer.length / ratio);
    const result = new Float32Array(len);
    for (let i = 0; i < len; i++) {
        const idx = Math.round(i * ratio);
        result[i] = buffer[Math.min(idx, buffer.length - 1)];
    }
    return result;
}

async function startRecording() {
    try {
        recordStream = await navigator.mediaDevices.getUserMedia({ audio: { channelCount: 1, sampleRate: RECORD_SAMPLE_RATE } });
        recordedPCM = [];

        audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: audioContext ? undefined : undefined });
        audioStreamSource = audioContext.createMediaStreamSource(recordStream);

        // Use ScriptProcessorNode (widely supported) to capture raw PCM
        const bufferSize = 4096;
        scriptProcessor = audioContext.createScriptProcessor(bufferSize, 1, 1);
        scriptProcessor.onaudioprocess = (e) => {
            const data = e.inputBuffer.getChannelData(0);
            recordedPCM.push(new Float32Array(data));
        };
        audioStreamSource.connect(scriptProcessor);
        scriptProcessor.connect(audioContext.destination);

        recordStartTime = Date.now();

        // Show recording UI
        document.getElementById('recordIdle').classList.add('hidden');
        document.getElementById('recordActive').classList.remove('hidden');
        document.getElementById('recordPreview').classList.add('hidden');
        document.getElementById('recordZone').classList.add('border-rose-500/30');
        document.getElementById('recordZone').classList.remove('border-white/10');

        // Timer
        updateRecordTimer();
        recordTimerInterval = setInterval(() => {
            updateRecordTimer();
            const elapsed = (Date.now() - recordStartTime) / 1000;
            if (elapsed >= MAX_RECORD_SECONDS) stopRecording();
        }, 500);

    } catch (err) {
        if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
            alert('Microphone access denied. Please allow microphone access in your browser settings.');
        } else {
            alert('Could not access microphone: ' + err.message);
        }
    }
}

function stopRecording() {
    clearInterval(recordTimerInterval);

    // Disconnect audio nodes
    if (scriptProcessor) { scriptProcessor.disconnect(); scriptProcessor = null; }
    if (audioStreamSource) { audioStreamSource.disconnect(); audioStreamSource = null; }
    if (recordStream) { recordStream.getTracks().forEach(t => t.stop()); recordStream = null; }

    document.getElementById('recordActive').classList.add('hidden');
    document.getElementById('recordZone').classList.remove('border-rose-500/30');
    document.getElementById('recordZone').classList.add('border-white/10');

    if (recordedPCM.length === 0) return;

    // Merge all PCM chunks
    const totalLength = recordedPCM.reduce((acc, buf) => acc + buf.length, 0);
    const merged = new Float32Array(totalLength);
    let offset = 0;
    for (const buf of recordedPCM) { merged.set(buf, offset); offset += buf.length; }

    // Downsample to 16kHz for speech recognition
    const nativeSR = audioContext ? audioContext.sampleRate : 44100;
    const downsampled = downsample(merged, nativeSR, RECORD_SAMPLE_RATE);
    const wavBlob = encodeWAV(downsampled, RECORD_SAMPLE_RATE);

    if (audioContext) { audioContext.close(); audioContext = null; }

    const file = new File([wavBlob], `recording_${Date.now()}.wav`, { type: 'audio/wav' });
    selectedAudioFile = file;
    showRecordedPreview(file);
    document.getElementById('analyzeAudioBtn').disabled = false;
}

function cancelRecording() {
    recordedPCM = [];
    clearInterval(recordTimerInterval);
    if (scriptProcessor) { scriptProcessor.disconnect(); scriptProcessor = null; }
    if (audioStreamSource) { audioStreamSource.disconnect(); audioStreamSource = null; }
    if (recordStream) { recordStream.getTracks().forEach(t => t.stop()); recordStream = null; }
    if (audioContext) { audioContext.close(); audioContext = null; }
    selectedAudioFile = null;
    document.getElementById('analyzeAudioBtn').disabled = true;
    document.getElementById('recordActive').classList.add('hidden');
    document.getElementById('recordPreview').classList.add('hidden');
    document.getElementById('recordIdle').classList.remove('hidden');
    document.getElementById('recordZone').classList.remove('border-rose-500/30');
    document.getElementById('recordZone').classList.add('border-white/10');
}

function updateRecordTimer() {
    const elapsed = Math.floor((Date.now() - recordStartTime) / 1000);
    const mins = String(Math.floor(elapsed / 60)).padStart(2, '0');
    const secs = String(elapsed % 60).padStart(2, '0');
    document.getElementById('recordTimer').textContent = `${mins}:${secs}`;
}

function showRecordedPreview(file) {
    const previewEl = document.getElementById('recordPreview');
    const audioURL = URL.createObjectURL(file);
    const duration = ((Date.now() - recordStartTime) / 1000).toFixed(1);
    previewEl.classList.remove('hidden');
    previewEl.innerHTML = `
        <div class="flex flex-col items-center gap-3">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-xl bg-emerald-500/10 flex items-center justify-center">
                    <svg class="w-6 h-6 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                </div>
                <div class="text-left">
                    <p class="text-sm text-white font-medium">Recording captured</p>
                    <p class="text-xs text-dark-500">${duration}s · ${(file.size / 1024).toFixed(1)} KB</p>
                </div>
                <button onclick="cancelRecording()" class="text-xs text-rose-400 hover:text-rose-300 ml-2">Discard</button>
            </div>
            <audio controls src="${audioURL}" class="w-full max-w-md h-8 mt-1" style="filter: invert(1) hue-rotate(180deg) brightness(0.8);"></audio>
        </div>`;
}

// ──────── Image Analysis ────────
async function analyzeImage() {
    if (!selectedImageFile) { alert('Please select an image first'); return; }

    const btn = document.getElementById('analyzeImageBtn');
    const resultDiv = document.getElementById('analysisResult');
    const title = document.getElementById('imageTitle').value.trim() || `Image: ${selectedImageFile.name}`;
    btn.disabled = true;
    btn.innerHTML = '<div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div> Extracting text with OCR...';
    resultDiv.className = 'mt-6';
    resultDiv.innerHTML = '<div class="p-4 rounded-xl bg-violet-500/5 border border-violet-500/20 text-sm text-dark-400 flex items-center gap-3"><div class="animate-spin w-5 h-5 border-2 border-violet-500 border-t-transparent rounded-full flex-shrink-0"></div><div><div class="text-white font-medium mb-0.5">Processing image...</div>Running Tesseract OCR to extract text, then analyzing for misinformation</div></div>';

    try {
        const formData = new FormData();
        formData.append('image', selectedImageFile);
        formData.append('title', title);

        const resp = await fetch('/api/analyze-image/', {
            method: 'POST',
            body: formData
        });
        const data = await resp.json();
        if (!data.success) throw new Error(data.error);

        // Show OCR result + analysis
        const ocrInfo = data.ocr_result || {};
        const ocrBanner = `<div class="p-4 rounded-xl bg-violet-500/5 border border-violet-500/20 mb-4">
            <div class="text-xs font-semibold text-violet-400 mb-2 flex items-center gap-1.5">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                OCR Extracted Text (${ocrInfo.word_count || 0} words · ${(ocrInfo.confidence || 0).toFixed(0)}% confidence)
            </div>
            <p class="text-sm text-dark-300 bg-white/5 rounded-lg p-3 max-h-32 overflow-y-auto">${ocrInfo.extracted_text || 'No text extracted'}</p>
        </div>`;

        resultDiv.className = 'mt-6';
        resultDiv.innerHTML = ocrBanner;
        const analysisDiv = document.createElement('div');
        resultDiv.appendChild(analysisDiv);
        renderInlineResult(data.results, analysisDiv);
    } catch(e) {
        resultDiv.innerHTML = `<div class="p-4 rounded-xl bg-rose-500/5 border border-rose-500/20 text-rose-400 text-sm">${e.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg> Extract Text & Analyze Image';
    }
}

// ──────── Audio Analysis ────────
async function analyzeAudio() {
    if (!selectedAudioFile) { alert('Please select an audio file first'); return; }

    const btn = document.getElementById('analyzeAudioBtn');
    const resultDiv = document.getElementById('analysisResult');
    const title = document.getElementById('audioTitle').value.trim() || `Audio: ${selectedAudioFile.name}`;
    btn.disabled = true;
    btn.innerHTML = '<div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div> Transcribing audio...';
    resultDiv.className = 'mt-6';
    resultDiv.innerHTML = '<div class="p-4 rounded-xl bg-cyan-500/5 border border-cyan-500/20 text-sm text-dark-400 flex items-center gap-3"><div class="animate-spin w-5 h-5 border-2 border-cyan-500 border-t-transparent rounded-full flex-shrink-0"></div><div><div class="text-white font-medium mb-0.5">Processing audio...</div>Converting speech to text, then analyzing for misinformation</div></div>';

    try {
        const formData = new FormData();
        formData.append('audio', selectedAudioFile);
        formData.append('title', title);

        const resp = await fetch('/api/analyze-audio/', {
            method: 'POST',
            body: formData
        });
        const data = await resp.json();
        if (!data.success) throw new Error(data.error);

        // Show transcription + analysis
        const txInfo = data.transcription || {};
        const txBanner = `<div class="p-4 rounded-xl bg-cyan-500/5 border border-cyan-500/20 mb-4">
            <div class="text-xs font-semibold text-cyan-400 mb-2 flex items-center gap-1.5">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
                Audio Transcription (${txInfo.word_count || 0} words · ${(txInfo.duration_seconds || 0).toFixed(1)}s)
            </div>
            <p class="text-sm text-dark-300 bg-white/5 rounded-lg p-3 max-h-32 overflow-y-auto">${txInfo.transcribed_text || 'No speech detected'}</p>
        </div>`;

        resultDiv.className = 'mt-6';
        resultDiv.innerHTML = txBanner;
        const analysisDiv = document.createElement('div');
        resultDiv.appendChild(analysisDiv);
        renderInlineResult(data.results, analysisDiv);
    } catch(e) {
        resultDiv.innerHTML = `<div class="p-4 rounded-xl bg-rose-500/5 border border-rose-500/20 text-rose-400 text-sm">${e.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg> Transcribe & Analyze Audio';
    }
}

// ──────── Analyze Content ────────
async function analyzeContent() {
    const title = document.getElementById('contentTitle').value.trim();
    const text = document.getElementById('contentText').value.trim();
    const url = document.getElementById('contentUrl').value.trim();
    if (!title || !text) { alert('Please enter both title and content text'); return; }

    const btn = document.getElementById('analyzeBtn');
    const resultDiv = document.getElementById('analysisResult');
    btn.disabled = true;
    btn.innerHTML = '<div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div> Scraping web sources & analyzing...';
    resultDiv.className = 'mt-6';
    resultDiv.innerHTML = '<div class="p-4 rounded-xl bg-indigo-500/5 border border-indigo-500/20 text-sm text-dark-400 flex items-center gap-3"><div class="animate-spin w-5 h-5 border-2 border-indigo-500 border-t-transparent rounded-full flex-shrink-0"></div><div><div class="text-white font-medium mb-0.5">Searching the web...</div>Scraping news sources, cross-referencing fact-checkers, running AI analysis</div></div>';

    try {
        const resp = await fetch('/api/analyze/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, text, url, source_name: url ? new URL(url).hostname : 'User Input' })
        });
        const data = await resp.json();
        if (!data.success) throw new Error(data.error);
        renderInlineResult(data.results, resultDiv);
    } catch(e) {
        resultDiv.innerHTML = `<div class="p-4 rounded-xl bg-rose-500/5 border border-rose-500/20 text-rose-400 text-sm">${e.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg> Analyze Content';
    }
}

function renderInlineResult(r, el) {
    _lastAnalysisResult = r;
    const ml = r.misinformation_likelihood || 0;
    const pct = (ml * 100).toFixed(1);
    const risk = r.risk_level || 'low';
    const rc = risk === 'critical' ? 'rose' : risk === 'high' ? 'amber' : risk === 'medium' ? 'blue' : 'emerald';
    const impact = r.societal_impact_score || 0;
    const amp = r.amplification_risk || 0;
    const reach = (r.estimated_reach || 0).toLocaleString();
    const conf = ((r.confidence || 0) * 100).toFixed(0);
    const expl = r.explanation || 'No explanation available.';
    const srcAttr = r.source_attribution || '';
    const topics = (r.affected_topics || []).join(', ') || 'General';
    const fcs = r.fact_checks || [];
    const indicators = r.key_indicators || [];
    const ws = r.web_sources || {};

    // Build web sources section
    let webSourcesHTML = '';
    if (ws.total > 0) {
        const sourceNames = ws.source_names || [];
        const sourceDetails = ws.sources_detail || [];
        const consensus = ws.consensus || 'insufficient';
        const consensusLabel = consensus === 'mostly_denied' ? '🔴 Mostly Denied' :
            consensus === 'mostly_supported' ? '🟢 Mostly Supported' :
            consensus === 'conflicting' ? '🟡 Conflicting' : '⚪ Insufficient Data';

        webSourcesHTML = `
        <div class="p-4 rounded-lg bg-cyan-500/5 border border-cyan-500/10 mb-4">
            <div class="text-xs font-semibold text-cyan-400 mb-3 flex items-center gap-1.5">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/></svg>
                Web Sources Scraped (${ws.total} sources) — ${consensusLabel}
            </div>
            <div class="flex flex-wrap gap-1.5 mb-3">
                ${sourceNames.map(n => '<span class="indicator-pill bg-white/10 text-white text-xs">' + n + '</span>').join('')}
            </div>
            ${sourceDetails.length > 0 ? `
            <div class="space-y-2">
                ${sourceDetails.slice(0, 4).map(s => {
                    const tc = s.type === 'fact_checker' ? 'violet' : s.type === 'mainstream' ? 'cyan' : 'dark';
                    return '<div class="flex items-start gap-2 p-2 rounded-lg bg-white/5">' +
                        '<span class="indicator-pill bg-' + tc + '-500/10 text-' + tc + '-400 flex-shrink-0 text-xs">' + (s.type === 'fact_checker' ? '✓ Fact-Checker' : s.type === 'mainstream' ? '📰 News' : '🌐 Web') + '</span>' +
                        '<div class="min-w-0">' +
                            '<div class="text-xs font-medium text-white">' + s.name + ' <span class="text-dark-600">— ' + s.credibility + '/10 credibility</span></div>' +
                            '<div class="text-xs text-dark-400 truncate">' + s.title + '</div>' +
                        '</div>' +
                    '</div>';
                }).join('')}
            </div>` : ''}
        </div>`;
    }

    el.innerHTML = `
    <div class="p-5 rounded-xl border border-${rc}-500/20 bg-${rc}-500/5">
        <div class="flex items-center justify-between mb-5">
            <div class="flex items-center gap-3">
                <div class="w-14 h-14 rounded-xl bg-${rc}-500/10 flex items-center justify-center">
                    <span class="text-xl font-bold text-${rc}-400">${pct}%</span>
                </div>
                <div>
                    <div class="text-sm font-bold text-white">Misinformation Likelihood</div>
                    <div class="text-xs text-dark-400">Confidence: ${conf}% · ${ws.total || 0} web sources checked</div>
                </div>
            </div>
            <span class="px-3 py-1.5 rounded-lg bg-${rc}-500/20 text-${rc}-400 text-sm font-bold">${risk.toUpperCase()}</span>
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 mb-5">
            <div class="p-3 rounded-lg bg-white/5 text-center">
                <div class="text-lg font-bold text-white">${(ml * 100).toFixed(0)}%</div>
                <div class="text-xs text-dark-500">Misinfo</div>
            </div>
            <div class="p-3 rounded-lg bg-white/5 text-center">
                <div class="text-lg font-bold text-white">${impact.toFixed(1)}</div>
                <div class="text-xs text-dark-500">Impact /10</div>
            </div>
            <div class="p-3 rounded-lg bg-white/5 text-center">
                <div class="text-lg font-bold text-white">${(amp * 100).toFixed(0)}%</div>
                <div class="text-xs text-dark-500">Amp. Risk</div>
            </div>
            <div class="p-3 rounded-lg bg-white/5 text-center">
                <div class="text-lg font-bold text-white">${reach}</div>
                <div class="text-xs text-dark-500">Est. Reach</div>
            </div>
        </div>
        <div class="mb-4">
            <div class="text-xs text-dark-500 mb-1.5">Sensitive Topics</div>
            <div class="flex flex-wrap gap-1.5">${topics.split(', ').map(t => '<span class="indicator-pill bg-white/5 text-dark-300">' + t + '</span>').join('')}</div>
        </div>
        ${webSourcesHTML}
        <div class="p-4 rounded-lg bg-white/5 mb-4">
            <div class="text-xs font-semibold text-indigo-400 mb-2 flex items-center gap-1.5">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
                AI Reasoning ${srcAttr ? '— with Source Attribution' : ''}
            </div>
            <p class="text-sm text-dark-300 leading-relaxed">${expl}</p>
            ${srcAttr ? '<p class="text-sm text-dark-300 mt-3 pt-3 border-t border-white/5 italic">' + srcAttr + '</p>' : ''}
        </div>
        ${indicators.length > 0 ? `
        <div class="mb-4">
            <div class="text-xs font-semibold text-dark-400 mb-2">Key Indicators</div>
            <div class="space-y-1.5">
                ${indicators.slice(0, 5).map(i => {
                    const s = i.score || 0;
                    const c = s > 0.6 ? 'rose' : s > 0.3 ? 'amber' : 'emerald';
                    return '<div class="flex items-start gap-2 text-xs"><span class="indicator-pill bg-' + c + '-500/10 text-' + c + '-400 flex-shrink-0">' + (s*100).toFixed(0) + '%</span><span class="text-dark-300">' + (i.description || i.type) + '</span></div>';
                }).join('')}
            </div>
        </div>` : ''}
        ${fcs.length > 0 ? `
        <div>
            <div class="text-xs font-semibold text-dark-400 mb-2">Fact-Check Results</div>
            <div class="space-y-2">
                ${fcs.slice(0, 3).map(fc => {
                    const rating = (fc.rating || '').toLowerCase();
                    const c = rating.includes('false') ? 'rose' : rating.includes('true') ? 'emerald' : 'amber';
                    return '<div class="p-3 rounded-lg bg-white/5 flex items-start justify-between gap-3"><div class="min-w-0"><div class="text-xs text-dark-500">' + (fc.publisher || 'Unknown') + '</div><div class="text-sm text-white truncate">' + (fc.claim_text || '') + '</div></div><span class="indicator-pill bg-' + c + '-500/10 text-' + c + '-400 flex-shrink-0">' + (fc.rating || 'Unrated') + '</span></div>';
                }).join('')}
            </div>
        </div>` : ''}
        <div class="mt-4 flex justify-center gap-2 flex-wrap">
            <button onclick="showVerificationFlowchart(this)" class="group inline-flex items-center gap-1.5 px-3.5 py-1.5 rounded-lg bg-white/5 border border-white/10 hover:border-indigo-500/30 text-xs font-medium text-dark-400 hover:text-indigo-400 transition-all duration-200">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/></svg>
                <span>Show Verification Process</span>
            </button>
            <button onclick="showForecast(this)" class="group inline-flex items-center gap-1.5 px-3.5 py-1.5 rounded-lg bg-white/5 border border-white/10 hover:border-cyan-500/30 text-xs font-medium text-dark-400 hover:text-cyan-400 transition-all duration-200">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                <span>Forecast</span>
            </button>
        </div>
        <div id="verificationFlowchart" class="hidden mt-5"></div>
        <div id="forecastContainer" class="hidden mt-5"></div>
    </div>`;
}

// ──────── Verification Process Flowchart ────────
var _lastAnalysisResult = null;

function showVerificationFlowchart(btn) {
    const container = document.getElementById('verificationFlowchart');
    if (!container) return;
    if (!container.classList.contains('hidden')) {
        container.classList.add('hidden');
        container.innerHTML = '';
        btn.querySelector('span').textContent = 'Show Verification Process';
        return;
    }
    btn.querySelector('span').textContent = 'Hide Verification Process';
    container.classList.remove('hidden');

    const r = _lastAnalysisResult || {};
    const ws = r.web_sources || {};
    const fcs = r.fact_checks || [];
    const indicators = r.key_indicators || [];
    const ml = r.misinformation_likelihood || 0;
    const pct = (ml * 100).toFixed(1);
    const risk = r.risk_level || 'low';
    const conf = ((r.confidence || 0) * 100).toFixed(0);
    const srcNames = ws.source_names || [];
    const srcDetail = ws.sources_detail || [];
    const consensus = ws.consensus || 'insufficient';
    const fcCount = fcs.length;
    const webTotal = ws.total || 0;
    const expl = r.explanation || '';

    // Status helpers
    var ok = '<span class="fc-status fc-status-ok">✓</span>';
    var warn = '<span class="fc-status fc-status-warn">⚠</span>';
    var err = '<span class="fc-status fc-status-err">✗</span>';
    var info = '<span class="fc-status fc-status-info">i</span>';

    var webStatus = webTotal > 0 ? ok : warn;
    var fcStatus = fcCount > 0 ? ok : warn;
    var aiStatus = conf > 50 ? ok : info;
    var riskIcon = risk === 'critical' || risk === 'high' ? err : risk === 'medium' ? warn : ok;
    var consensusStatus = consensus === 'mostly_denied' ? err : consensus === 'mostly_supported' ? ok : consensus === 'conflicting' ? warn : info;

    function srcLink(s) {
        var name = (s.name || s.source_name || 'Source').substring(0, 22);
        var url = s.url || '#';
        return '<a href="' + url + '" target="_blank" class="fc-src-link"><svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg>' + name + '</a>';
    }

    // Build steps
    var steps = [];

    // Step 1 — Input
    steps.push({
        num: 1, title: 'Input Received', status: ok,
        body: '<span class="text-white">' + (r.title || 'Content analyzed').substring(0, 50) + (((r.title||'').length > 50) ? '…' : '') + '</span>'
    });

    // Step 2 — Web Search
    var webBody = webTotal > 0
        ? 'Scraped & analyzed <span class="text-white font-medium">' + webTotal + '</span> web results' +
          (srcDetail.length > 0 ? '<div class="mt-1.5 space-y-0.5">' + srcDetail.slice(0,2).map(srcLink).join('') + '</div>' : '')
        : 'No web sources found for verification';
    steps.push({ num: 2, title: 'Web Search & Scraping', status: webStatus, body: webBody });

    // Step 3 — Fact Check
    steps.push({
        num: 3, title: 'Fact-Check Database', status: fcStatus,
        body: fcCount > 0
            ? '<span class="text-white font-medium">' + fcCount + '</span> existing fact-check' + (fcCount > 1 ? 's' : '') + ' found'
            : 'No existing fact-checks found'
    });

    // Step 4 — Consensus
    var cText = consensus === 'mostly_denied' ? 'Sources <span class="text-rose-400 font-medium">mostly deny</span> this claim'
        : consensus === 'mostly_supported' ? 'Sources <span class="text-emerald-400 font-medium">mostly support</span> this claim'
        : consensus === 'conflicting' ? 'Sources show <span class="text-amber-400 font-medium">conflicting</span> views'
        : 'Insufficient data for consensus';
    steps.push({
        num: 4, title: 'Source Consensus', status: consensusStatus,
        body: cText + (srcNames.length > 0 ? '<div class="mt-1 text-dark-500 text-[10px]">' + srcNames.slice(0,4).join(' · ') + '</div>' : '')
    });

    // Step 5 — AI Analysis
    var indicatorTypes = indicators.slice(0,3).map(function(i){ return i.type || ''; }).filter(Boolean);
    var aiBody = 'Confidence: <span class="text-white font-medium">' + conf + '%</span> — ' +
        (ml > 0.6 ? '<span class="text-rose-400">Likely False</span>' : ml > 0.3 ? '<span class="text-amber-400">Uncertain</span>' : '<span class="text-emerald-400">Likely True</span>');
    if (indicatorTypes.length > 0) aiBody += '<div class="mt-1 text-dark-500 text-[10px]">' + indicatorTypes.join(', ') + '</div>';
    steps.push({ num: 5, title: 'AI Deep Analysis', status: aiStatus, body: aiBody });

    // Step 6 — URL Safety
    var hasUrl = r.url || '';
    steps.push({
        num: 6, title: 'URL Safety Check', status: hasUrl ? ok : info,
        body: hasUrl ? 'No security threats detected' : 'No URL provided for safety check'
    });

    // Build HTML
    var h = '<div class="fc-container">';
    // Header
    h += '<div class="fc-header">';
    h += '<div class="fc-header-icon"><svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2"/></svg></div>';
    h += '<div>';
    h += '<h3 class="text-sm font-bold text-white">Verification Pipeline</h3>';
    h += '<p class="text-xs text-dark-400">How your content was verified, step by step</p>';
    h += '</div>';
    h += '</div>';

    // Flow
    h += '<div class="fc-flow">';
    steps.forEach(function(step, i) {
        var isLast = (i === steps.length - 1);
        h += '<div class="fc-step" data-step="' + i + '">';
        // Timeline
        h += '<div class="fc-timeline">';
        h += '<div class="fc-node" data-idx="' + i + '"><div class="fc-node-inner"></div></div>';
        if (!isLast) {
            h += '<div class="fc-connector"><div class="fc-connector-track"></div><div class="fc-connector-fill" data-idx="' + i + '"></div></div>';
        }
        h += '</div>';
        // Arm (horizontal arrow)
        h += '<div class="fc-arm"><div class="fc-arm-line" data-idx="' + i + '"></div><div class="fc-arm-arrow" data-idx="' + i + '"></div></div>';
        // Card
        h += '<div class="fc-card" data-idx="' + i + '">';
        h += '<div class="flex items-start justify-between gap-2 mb-1.5">';
        h += '<div class="flex items-center gap-2 min-w-0">';
        h += '<span class="fc-step-num">' + step.num + '</span>';
        h += '<h4 class="text-xs font-bold text-white leading-tight">' + step.title + '</h4>';
        h += '</div>';
        h += step.status;
        h += '</div>';
        h += '<div class="text-xs text-dark-400 leading-relaxed">' + step.body + '</div>';
        h += '</div>';
        h += '</div>';
    });
    h += '</div>';

    // Verdict
    var verdictColor = risk === 'critical' || risk === 'high' ? 'rose' : risk === 'medium' ? 'amber' : 'emerald';
    var verdictBg = 'rgba(' + (verdictColor === 'rose' ? '239,68,68' : verdictColor === 'amber' ? '245,158,11' : '16,185,129') + ',0.05)';
    var verdictBorder = 'rgba(' + (verdictColor === 'rose' ? '239,68,68' : verdictColor === 'amber' ? '245,158,11' : '16,185,129') + ',0.15)';
    var verdictText = expl.length > 280 ? expl.substring(0, 280) + '…' : expl;

    h += '<div class="mt-5 ml-[36px] pl-[20px]">';
    h += '<div class="fc-verdict" data-final style="background:' + verdictBg + ';border-color:' + verdictBorder + ';">';
    h += '<div class="flex items-center justify-between gap-2 mb-2">';
    h += '<div class="flex items-center gap-2">';
    h += '<svg class="w-4 h-4 text-' + verdictColor + '-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>';
    h += '<h4 class="text-xs font-bold text-white">Final Verdict</h4>';
    h += '</div>';
    h += riskIcon;
    h += '</div>';
    h += '<p class="text-xs text-dark-300 leading-relaxed mb-3">' + verdictText + '</p>';

    // Scores mini row
    h += '<div class="flex gap-3 flex-wrap mb-3">';
    h += '<div class="text-[10px] text-dark-500">Misinfo: <span class="text-white font-medium">' + pct + '%</span></div>';
    h += '<div class="text-[10px] text-dark-500">Confidence: <span class="text-white font-medium">' + conf + '%</span></div>';
    h += '<div class="text-[10px] text-dark-500">Risk: <span class="text-' + verdictColor + '-400 font-medium">' + risk.toUpperCase() + '</span></div>';
    h += '</div>';

    if (srcDetail.length > 0) {
        h += '<div class="space-y-0.5 pt-2 border-t border-white/5">';
        srcDetail.slice(0, 3).forEach(function(s) { h += srcLink(s); });
        h += '</div>';
    }
    h += '</div></div>';

    h += '</div>'; // close fc-container
    container.innerHTML = h;

    // Sequentially animate: node → connector → arm → card for each step
    var STEP_DELAY = 350; // ms between starting each step
    var totalSteps = steps.length;

    function animateStep(i) {
        if (i >= totalSteps) {
            // Animate verdict
            setTimeout(function() {
                var v = container.querySelector('[data-final]');
                if (v) v.classList.add('visible');
            }, 200);
            return;
        }
        // 1. Node appears
        var node = container.querySelector('.fc-node[data-idx="' + i + '"]');
        if (node) { node.classList.add('active'); setTimeout(function() { node.classList.add('done'); }, 200); }
        // 2. Arm line extends
        setTimeout(function() {
            var arm = container.querySelector('.fc-arm-line[data-idx="' + i + '"]');
            if (arm) arm.classList.add('live');
            var arrow = container.querySelector('.fc-arm-arrow[data-idx="' + i + '"]');
            if (arrow) arrow.classList.add('live');
        }, 120);
        // 3. Card fades in
        setTimeout(function() {
            var card = container.querySelector('.fc-card[data-idx="' + i + '"]');
            if (card) card.classList.add('visible');
        }, 240);
        // 4. Connector line fills down to next step
        setTimeout(function() {
            var fill = container.querySelector('.fc-connector-fill[data-idx="' + i + '"]');
            if (fill) fill.classList.add('live');
        }, 350);
        // Schedule next step
        setTimeout(function() { animateStep(i + 1); }, STEP_DELAY);
    }

    requestAnimationFrame(function() {
        setTimeout(function() { animateStep(0); }, 150);
    });

    setTimeout(function() {
        container.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
}

// ──────── Forecast Feature ────────
var _forecastCache = null;

function showForecast(btn) {
    const container = document.getElementById('forecastContainer');
    if (!container) return;

    // Toggle off
    if (!container.classList.contains('hidden')) {
        container.classList.add('hidden');
        container.innerHTML = '';
        btn.querySelector('span').textContent = 'Forecast';
        _forecastCache = null;
        return;
    }

    btn.querySelector('span').textContent = 'Hide Forecast';
    container.classList.remove('hidden');

    const r = _lastAnalysisResult || {};
    if (!r.title && !r.explanation) {
        container.innerHTML = '<p class="text-xs text-dark-500 text-center py-4">No analysis data available for forecasting.</p>';
        return;
    }

    // Show loading
    container.innerHTML = '<div class="forecast-container"><div class="forecast-loading">' +
        '<div class="spinner"></div>' +
        '<span class="text-xs text-dark-400">Generating future scenarios...</span>' +
        '</div></div>';

    // Call forecast API
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    const payload = {
        title: r.title || '',
        text: r.explanation || '',
        risk_level: r.risk_level || 'low',
        misinformation_likelihood: r.misinformation_likelihood || 0,
        confidence: r.confidence || 0,
        affected_topics: r.affected_topics || [],
        web_consensus: (r.web_sources || {}).consensus || 'insufficient',
        fact_check_count: (r.fact_checks || []).length,
    };

    fetch('/api/forecast/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
        body: JSON.stringify(payload)
    })
    .then(resp => {
        if (!resp.ok) {
            return resp.text().then(t => {
                try { const j = JSON.parse(t); throw new Error(j.error || 'Server error'); }
                catch(e) { if (e.message !== 'Server error' && !e.message.includes('unavailable')) throw new Error('Server returned ' + resp.status); throw e; }
            });
        }
        return resp.json();
    })
    .then(data => {
        if (!data.success) throw new Error(data.error || 'Forecast failed');
        renderForecast(container, data.forecast);
    })
    .catch(err => {
        console.error('Forecast error:', err);
        // Fallback: generate client-side forecast from analysis data
        renderForecast(container, generateLocalForecast(r));
    });
}

function generateLocalForecast(r) {
    const ml = r.misinformation_likelihood || 0;
    const risk = r.risk_level || 'low';
    const isHigh = ml > 0.5 || risk === 'high' || risk === 'critical';
    const isMed = ml > 0.25 || risk === 'medium';

    if (isHigh) {
        return {
            scenarios: [
                { title: 'Fabricated / Misleading Content', probability: 50, description: 'Multiple signals suggest this content is false or deliberately misleading. The claims lack credible sourcing and contradict verified reports.' },
                { title: 'Exaggerated Real Event', probability: 30, description: 'A real event may underlie this content, but key details appear distorted or sensationalized beyond factual accuracy.' },
                { title: 'Satire or Parody', probability: 20, description: 'This may have originated as satire or humor that was shared without proper context, leading to it being taken literally.' }
            ],
            summary: 'Analysis strongly suggests this content is misleading or fabricated.'
        };
    } else if (isMed) {
        return {
            scenarios: [
                { title: 'Partially True, Needs Context', probability: 45, description: 'Core claims have some basis in reality but are presented without essential context, leading to a potentially misleading interpretation.' },
                { title: 'Genuine but Unverified', probability: 35, description: 'The content could be authentic but lacks sufficient independent verification from established sources at this time.' },
                { title: 'Manipulated Narrative', probability: 20, description: 'Real facts may have been selectively framed or combined with false details to push a specific narrative.' }
            ],
            summary: 'This content appears partially credible but requires additional verification.'
        };
    } else {
        return {
            scenarios: [
                { title: 'Verified Authentic Report', probability: 55, description: 'The content aligns with multiple credible sources and established reporting. No significant red flags detected in the analysis.' },
                { title: 'Legitimate but Routine', probability: 30, description: 'This appears to be standard reporting or a factual claim that is accurate but not particularly noteworthy.' },
                { title: 'Minor Inaccuracies Possible', probability: 15, description: 'While broadly accurate, some minor details may be imprecise or slightly outdated without affecting the overall credibility.' }
            ],
            summary: 'This content appears credible and is supported by available evidence.'
        };
    }
}

function renderForecast(container, forecast) {
    const scenarios = forecast.scenarios || [];
    const summary = forecast.summary || '';

    const colors = [
        { fill: '#818cf8', text: 'text-indigo-400', badge: 'bg-indigo-500/10 text-indigo-400', border: 'border-indigo-500/15' },
        { fill: '#fbbf24', text: 'text-amber-400', badge: 'bg-amber-500/10 text-amber-400', border: 'border-amber-500/15' },
        { fill: '#34d399', text: 'text-emerald-400', badge: 'bg-emerald-500/10 text-emerald-400', border: 'border-emerald-500/15' },
    ];

    let h = '<div class="forecast-container">';

    // Header
    h += '<div class="forecast-header">';
    h += '<div class="fc-icon">⟁</div>';
    h += '<div>';
    h += '<h3 class="text-sm font-bold text-white">Forecast — What Is This Content?</h3>';
    h += '<p class="text-xs text-dark-400">AI-generated conclusions ranked by likelihood</p>';
    h += '</div>';
    h += '</div>';

    // Scenarios
    scenarios.slice(0, 3).forEach(function(sc, i) {
        const c = colors[i % colors.length];
        const prob = sc.probability || 0;
        const delay = (i + 1) * 150;

        h += '<div class="forecast-scenario ' + c.border + '" style="animation-delay:' + delay + 'ms;">';

        // Title row: "Scenario 1: Title | XX%"
        h += '<div class="flex items-center justify-between gap-3 mb-2">';
        h += '<div class="flex items-center gap-2 min-w-0">';
        h += '<span class="text-[10px] font-mono ' + c.text + ' font-bold whitespace-nowrap">Scenario ' + (i + 1) + ':</span>';
        h += '<span class="text-sm font-semibold text-white truncate">' + (sc.title || 'Unknown') + '</span>';
        h += '</div>';
        h += '<span class="indicator-pill ' + c.badge + ' text-xs font-bold whitespace-nowrap">' + prob + '%</span>';
        h += '</div>';

        // Description
        h += '<p class="text-xs text-dark-400 leading-relaxed mb-2">' + (sc.description || '') + '</p>';

        // Probability bar
        h += '<div class="forecast-prob-bar">';
        h += '<div class="forecast-prob-fill" style="width:0%;background:' + c.fill + ';" data-width="' + prob + '%"></div>';
        h += '</div>';
        h += '</div>';
    });

    // Summary
    if (summary) {
        h += '<div class="mt-3 p-3 rounded-lg bg-white/[0.03] border border-white/5">';
        h += '<p class="text-xs text-dark-300 leading-relaxed"><span class="text-white font-medium">Verdict:</span> ' + summary + '</p>';
        h += '</div>';
    }

    h += '</div>';
    container.innerHTML = h;

    // Animate probability bars
    requestAnimationFrame(function() {
        setTimeout(function() {
            container.querySelectorAll('.forecast-prob-fill').forEach(function(bar) {
                bar.style.width = bar.getAttribute('data-width');
            });
        }, 300);
    });
}

// ──────── Detail Modal ────────
function openAnalysisDetail(id) {
    showModal();
    fetch(`/api/analysis/${id}/`).then(r => r.json()).then(data => {
        if (!data.success) throw new Error(data.error);
        renderDetailModal(data.analysis);
    }).catch(e => {
        document.getElementById('modalBody').innerHTML = `<p class="text-rose-400 text-sm">${e.message}</p>`;
    });
}

function openAlertDetail(id) {
    showModal();
    fetch(`/api/alert/${id}/`).then(r => r.json()).then(data => {
        if (!data.success) throw new Error(data.error);
        const a = data.alert;
        renderDetailModal(a.analysis, {
            alertSeverity: a.severity,
            alertTitle: a.alert_title,
            alertMessage: a.message,
        });
    }).catch(e => {
        document.getElementById('modalBody').innerHTML = `<p class="text-rose-400 text-sm">${e.message}</p>`;
    });
}

function showModal() {
    const m = document.getElementById('detailModal');
    m.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    document.getElementById('modalTitle').textContent = 'Loading...';
    document.getElementById('modalMeta').textContent = '';
    document.getElementById('modalRiskBadge').innerHTML = '';
    document.getElementById('modalBody').innerHTML = '<div class="text-center py-8"><div class="animate-spin w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto"></div><p class="text-dark-400 text-sm mt-3">Loading full analysis...</p></div>';
}

function closeModal() {
    document.getElementById('detailModal').classList.add('hidden');
    document.body.style.overflow = '';
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

function renderDetailModal(a, alertInfo = null) {
    const ml = a.misinformation_likelihood || 0;
    const pct = (ml * 100).toFixed(1);
    const risk = a.risk_level || 'low';
    const rc = risk === 'critical' ? 'rose' : risk === 'high' ? 'amber' : risk === 'medium' ? 'blue' : 'emerald';

    // Header
    document.getElementById('modalTitle').textContent = a.title || 'Analysis Detail';
    document.getElementById('modalMeta').textContent = `${a.source_name || 'Unknown Source'} · Analyzed ${new Date(a.analyzed_at).toLocaleDateString()}`;
    document.getElementById('modalRiskBadge').innerHTML = `<span class="px-2.5 py-1 rounded-lg bg-${rc}-500/20 text-${rc}-400 text-xs font-bold">${risk.toUpperCase()}</span>`;

    const indicators = a.key_indicators || [];
    const fcs = a.fact_check_results || [];
    const topics = (a.affected_topics || []).join(', ') || 'General';
    const triggers = (a.emotional_triggers || []).join(', ') || 'None';

    let body = '';

    // Alert banner if from alert
    if (alertInfo) {
        const sc = alertInfo.alertSeverity === 'critical' ? 'rose' : alertInfo.alertSeverity === 'warning' ? 'amber' : 'blue';
        body += `<div class="p-4 rounded-xl bg-${sc}-500/5 border border-${sc}-500/20 mb-5">
            <div class="text-xs font-semibold text-${sc}-400 mb-1">ALERT — ${(alertInfo.alertSeverity || '').toUpperCase()}</div>
            <p class="text-sm text-dark-300">${alertInfo.alertMessage || ''}</p>
        </div>`;
    }

    // ── THREAT LEVEL HERO ──
    body += `
    <div class="flex items-center gap-5 mb-6 p-4 rounded-xl bg-white/5">
        <div class="relative w-20 h-20 flex-shrink-0">
            <svg class="w-full h-full -rotate-90" viewBox="0 0 80 80">
                <circle cx="40" cy="40" r="32" fill="none" stroke="rgba(255,255,255,0.05)" stroke-width="8"/>
                <circle cx="40" cy="40" r="32" fill="none" stroke="${rc === 'rose' ? '#ef4444' : rc === 'amber' ? '#f59e0b' : rc === 'blue' ? '#3b82f6' : '#10b981'}" stroke-width="8" stroke-linecap="round" stroke-dasharray="201" stroke-dashoffset="${201 - (201 * ml)}" class="score-ring"/>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
                <span class="text-lg font-bold text-white">${pct}%</span>
            </div>
        </div>
        <div>
            <div class="text-xs text-dark-500 mb-1">Misinformation Likelihood</div>
            <div class="text-white font-semibold">${risk.charAt(0).toUpperCase() + risk.slice(1)} Risk</div>
            <div class="text-xs text-dark-500 mt-1">Confidence: ${((a.confidence_score || 0) * 100).toFixed(0)}%</div>
        </div>
    </div>`;

    // ── SCORE CARDS ──
    body += `
    <div class="grid grid-cols-3 sm:grid-cols-5 gap-2 mb-6">
        <div class="p-3 rounded-lg bg-white/5 text-center">
            <div class="text-base font-bold text-white">${((a.credibility_score || 0)*100).toFixed(0)}%</div>
            <div class="text-xs text-dark-500">Credibility</div>
        </div>
        <div class="p-3 rounded-lg bg-white/5 text-center">
            <div class="text-base font-bold text-white">${(a.societal_impact_score || 0).toFixed(1)}</div>
            <div class="text-xs text-dark-500">Impact /10</div>
        </div>
        <div class="p-3 rounded-lg bg-white/5 text-center">
            <div class="text-base font-bold text-white">${((a.amplification_risk || 0)*100).toFixed(0)}%</div>
            <div class="text-xs text-dark-500">Amp. Risk</div>
        </div>
        <div class="p-3 rounded-lg bg-white/5 text-center">
            <div class="text-base font-bold text-white">${(a.estimated_reach || 0).toLocaleString()}</div>
            <div class="text-xs text-dark-500">Est. Reach</div>
        </div>
        <div class="p-3 rounded-lg bg-white/5 text-center">
            <div class="text-base font-bold text-white">${((a.bias_score || 0)*100).toFixed(0)}%</div>
            <div class="text-xs text-dark-500">Bias</div>
        </div>
    </div>`;

    // ── TOPICS & EMOTIONS ──
    body += `
    <div class="grid sm:grid-cols-2 gap-4 mb-6">
        <div>
            <div class="text-xs font-semibold text-dark-400 mb-2">Sensitive Topics</div>
            <div class="flex flex-wrap gap-1.5">${topics.split(', ').map(t => `<span class="indicator-pill bg-indigo-500/10 text-indigo-400">${t}</span>`).join('')}</div>
        </div>
        <div>
            <div class="text-xs font-semibold text-dark-400 mb-2">Emotional Triggers</div>
            <div class="flex flex-wrap gap-1.5">${triggers.split(', ').map(t => `<span class="indicator-pill bg-violet-500/10 text-violet-400">${t}</span>`).join('')}</div>
        </div>
    </div>`;

    // ── AI EXPLANATION ──
    body += `
    <div class="p-4 rounded-xl bg-indigo-500/5 border border-indigo-500/10 mb-6">
        <div class="text-xs font-semibold text-indigo-400 mb-2 flex items-center gap-1.5">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>
            SatyaSetu AI Reasoning
        </div>
        <p class="text-sm text-dark-300 leading-relaxed whitespace-pre-line">${a.explanation || 'No explanation available.'}</p>
    </div>`;

    // ── CONTENT PREVIEW ──
    if (a.text) {
        const preview = a.text.length > 400 ? a.text.substring(0, 400) + '...' : a.text;
        body += `
        <div class="mb-6">
            <div class="text-xs font-semibold text-dark-400 mb-2">Original Content</div>
            <div class="p-4 rounded-lg bg-white/5 text-sm text-dark-300 leading-relaxed">${preview}</div>
            ${a.url ? `<a href="${a.url}" target="_blank" class="inline-flex items-center gap-1 text-xs text-indigo-400 hover:text-indigo-300 mt-2">View original source <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/></svg></a>` : ''}
        </div>`;
    }

    // ── KEY INDICATORS ──
    if (indicators.length > 0) {
        body += `
        <div class="mb-6">
            <div class="text-xs font-semibold text-dark-400 mb-3">Detection Indicators</div>
            <div class="space-y-2">
                ${indicators.map(i => {
                    const s = i.score || 0;
                    const c = s > 0.6 ? 'rose' : s > 0.3 ? 'amber' : 'emerald';
                    return `<div class="flex items-start gap-3 p-3 rounded-lg bg-white/5">
                        <span class="indicator-pill bg-${c}-500/10 text-${c}-400 flex-shrink-0">${(s*100).toFixed(0)}%</span>
                        <div>
                            <div class="text-xs font-medium text-dark-300">${i.type ? i.type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : ''}</div>
                            <div class="text-xs text-dark-500 mt-0.5">${i.description || ''}</div>
                        </div>
                    </div>`;
                }).join('')}
            </div>
        </div>`;
    }

    // ── FACT CHECKS ──
    if (fcs.length > 0) {
        body += `
        <div>
            <div class="text-xs font-semibold text-dark-400 mb-3">Fact-Check Cross-Reference</div>
            <div class="space-y-2">
                ${fcs.map(fc => {
                    const rating = (fc.rating || '').toLowerCase();
                    const c = rating.includes('false') || rating.includes('fake') || rating.includes('misleading') ? 'rose' : rating.includes('true') || rating.includes('correct') ? 'emerald' : 'amber';
                    return `<div class="p-3 rounded-lg bg-white/5">
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-xs font-medium text-dark-400">${fc.publisher || 'Unknown'}</span>
                            <span class="indicator-pill bg-${c}-500/10 text-${c}-400">${fc.rating || 'Unrated'}</span>
                        </div>
                        <div class="text-sm text-white">${fc.claim_text || ''}</div>
                        ${fc.url ? `<a href="${fc.url}" target="_blank" class="text-xs text-indigo-400 hover:text-indigo-300 mt-1 inline-block">View fact-check →</a>` : ''}
                    </div>`;
                }).join('')}
            </div>
        </div>`;
    }

    document.getElementById('modalBody').innerHTML = body;
}

// ──────── News Intelligence Feed ────────
async function fetchNewsFeed(btn) {
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<div class="animate-spin w-4 h-4 border-2 border-white border-t-transparent rounded-full"></div> Fetching & Analyzing...';

    const statusEl = document.getElementById('newsFeedStatus');
    const resultsEl = document.getElementById('newsFeedResults');
    const category = document.getElementById('newsCategory').value;
    const search = document.getElementById('newsQuery').value.trim();

    statusEl.classList.remove('hidden');
    statusEl.innerHTML = '<div class="flex items-center gap-2 text-sm text-indigo-400"><div class="animate-spin w-4 h-4 border-2 border-indigo-500 border-t-transparent rounded-full"></div>Fetching news articles, scraping web sources & running AI analysis... This may take a minute.</div>';
    resultsEl.innerHTML = '';

    try {
        const body = { auto_analyze: true };
        if (category !== 'general') body.category = category;
        if (search) body.query = search;

        const resp = await fetch('/api/fetch-news/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await resp.json();
        if (!data.success) throw new Error(data.error || 'Failed to fetch news');

        const feed = data.feed || [];
        const analyzed = data.articles_analyzed || 0;
        const found = data.articles_found || 0;

        statusEl.innerHTML = '<div class="text-xs text-dark-400">' + found + ' articles found · ' + analyzed + ' analyzed with web verification</div>';

        if (feed.length === 0) {
            resultsEl.innerHTML = '<div class="text-center py-8 text-dark-500 text-sm">No articles found. Try a different category or search term.</div>';
            return;
        }

        resultsEl.innerHTML = feed.map(article => renderNewsFeedCard(article)).join('');

    } catch(e) {
        statusEl.innerHTML = '<div class="text-rose-400 text-sm">Error: ' + e.message + '</div>';
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    }
}

function renderNewsFeedCard(a) {
    const ml = a.misinformation_likelihood || 0;
    const pct = (ml * 100).toFixed(0);
    const risk = a.risk_level || 'low';
    const rc = risk === 'critical' ? 'rose' : risk === 'high' ? 'amber' : risk === 'medium' ? 'blue' : 'emerald';
    const ws = a.web_sources || {};
    const sourceNames = ws.source_names || [];
    const consensus = ws.consensus || 'insufficient';
    const consensusLabel = consensus === 'mostly_denied' ? '🔴 Denied' :
        consensus === 'mostly_supported' ? '🟢 Supported' :
        consensus === 'conflicting' ? '🟡 Conflicting' : '⚪ Pending';
    const expl = a.explanation || '';
    const srcAttr = a.source_attribution || '';
    const topics = a.affected_topics || [];
    const credScore = a.credibility_score ? (a.credibility_score * 100).toFixed(0) + '%' : 'N/A';
    const analysisId = a.analysis_id || '';
    const clickAttr = analysisId ? ' onclick="openAnalysisDetail(' + analysisId + ')" style="cursor:pointer;"' : '';

    return '<div class="glass-card p-4 rounded-xl border border-white/5 hover:border-' + rc + '-500/30 transition-all duration-300"' + clickAttr + '>' +
        '<div class="flex items-start gap-4">' +
            (a.image_url ? '<img src="' + a.image_url + '" class="w-20 h-20 rounded-lg object-cover flex-shrink-0" onerror="this.style.display=\'none\'">' : '') +
            '<div class="flex-1 min-w-0">' +
                '<div class="flex items-center justify-between gap-2 mb-1">' +
                    '<div class="text-xs text-dark-500">' + (a.source_name || 'Unknown Source') + '</div>' +
                    '<div class="flex items-center gap-2">' +
                        '<span class="px-2 py-0.5 rounded-md bg-' + rc + '-500/20 text-' + rc + '-400 text-xs font-bold">' + pct + '% ' + risk.toUpperCase() + '</span>' +
                    '</div>' +
                '</div>' +
                '<h3 class="text-sm font-semibold text-white mb-2 line-clamp-2">' + (a.title || 'Untitled') + '</h3>' +
                (expl ? '<p class="text-xs text-dark-400 mb-2 line-clamp-2">' + expl + '</p>' : '') +
                (topics.length > 0 ? '<div class="flex flex-wrap gap-1 mb-2">' + topics.slice(0, 3).map(function(t) { return '<span class="indicator-pill bg-white/5 text-dark-400 text-xs">' + t + '</span>'; }).join('') + '</div>' : '') +
                '<div class="flex flex-wrap items-center gap-2 mb-2">' +
                    '<span class="text-xs text-dark-500">Credibility: ' + credScore + '</span>' +
                    '<span class="text-xs px-1.5 py-0.5 rounded bg-cyan-500/10 text-cyan-400">' + consensusLabel + '</span>' +
                    (ws.fact_checker_count > 0 ? '<span class="text-xs text-violet-400">' + ws.fact_checker_count + ' fact-checker(s)</span>' : '') +
                '</div>' +
                (sourceNames.length > 0 ? '<div class="flex flex-wrap items-center gap-1"><span class="text-xs text-dark-600">Scraped from:</span>' + sourceNames.slice(0, 5).map(function(n) { return '<span class="text-xs px-1.5 py-0.5 rounded bg-cyan-500/5 text-cyan-400/80">' + n + '</span>'; }).join('') + '</div>' : '') +
                (srcAttr ? '<p class="text-xs text-dark-500 mt-2 italic line-clamp-1">' + srcAttr + '</p>' : '') +
            '</div>' +
        '</div>' +
    '</div>';
}

// ──────── Auto-refresh alerts ────────
setInterval(async () => {
    try {
        const r = await fetch('/api/alerts/?limit=5');
        const d = await r.json();
        if (d.success) console.log('Alerts:', d.alerts.length);
    } catch(e) {}
}, 30000);

// ── Enhanced UI Animations ──
(function() {
    // Scroll Reveal for sections
    var obs = new IntersectionObserver(function(entries) {
        entries.forEach(function(e) {
            if (e.isIntersecting) { e.target.classList.add('revealed'); obs.unobserve(e.target); }
        });
    }, { threshold: 0.06, rootMargin: '0px 0px -30px 0px' });
    document.querySelectorAll('.reveal-section').forEach(function(el) { obs.observe(el); });

    // Animated Counters for stat values
    var sg = document.querySelector('.stats-grid');
    if (sg) {
        sg.querySelectorAll('.text-2xl').forEach(function(el, idx) {
            var child = el.querySelector('span');
            var raw = child ? el.childNodes[0].textContent.trim() : el.textContent.trim();
            var m = raw.match(/^([\d.]+)(.*)$/);
            if (!m) return;
            var target = parseFloat(m[1]);
            var trail = m[2];
            var childHTML = child ? child.outerHTML : '';
            var isF = raw.includes('.');
            setTimeout(function() {
                var start = performance.now();
                (function tick(now) {
                    var p = Math.min((now - start) / 1800, 1);
                    var ease = 1 - Math.pow(1 - p, 4);
                    var v = isF ? (target * ease).toFixed(1) : Math.floor(target * ease);
                    el.innerHTML = childHTML ? v + childHTML : v + trail;
                    if (p < 1) requestAnimationFrame(tick);
                })(performance.now());
            }, 350 + idx * 120);
        });
    }

    // Nav Scroll Effect
    var nav = document.getElementById('mainNav');
    if (nav) {
        var ticking = false;
        window.addEventListener('scroll', function() {
            if (!ticking) {
                requestAnimationFrame(function() {
                    nav.classList.toggle('nav-scrolled', window.scrollY > 20);
                    ticking = false;
                });
                ticking = true;
            }
        }, { passive: true });
    }

    // Particle Background
    var cvs = document.getElementById('particleBg');
    if (cvs) {
        var ctx = cvs.getContext('2d');
        var W, H;
        var pts = [];
        function onResize() { W = cvs.width = window.innerWidth; H = cvs.height = window.innerHeight; }
        onResize();
        window.addEventListener('resize', onResize);
        for (var i = 0; i < 40; i++) {
            pts.push({ x: Math.random()*W, y: Math.random()*H, vx: (Math.random()-0.5)*0.2, vy: (Math.random()-0.5)*0.15, r: Math.random()*1.2+0.3, a: Math.random()*0.18+0.04 });
        }
        (function draw() {
            ctx.clearRect(0, 0, W, H);
            for (var i = 0; i < pts.length; i++) {
                var p = pts[i];
                p.x += p.vx; p.y += p.vy;
                if (p.x < 0) p.x = W; if (p.x > W) p.x = 0;
                if (p.y < 0) p.y = H; if (p.y > H) p.y = 0;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                ctx.fillStyle = 'rgba(99,102,241,' + p.a + ')'; ctx.fill();
            }
            for (var i = 0; i < pts.length; i++) {
                for (var j = i + 1; j < pts.length; j++) {
                    var dx = pts[i].x - pts[j].x, dy = pts[i].y - pts[j].y;
                    var dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 150) {
                        ctx.beginPath(); ctx.moveTo(pts[i].x, pts[i].y); ctx.lineTo(pts[j].x, pts[j].y);
                        ctx.strokeStyle = 'rgba(99,102,241,' + (0.03 * (1 - dist / 150)) + ')';
                        ctx.lineWidth = 0.5; ctx.stroke();
                    }
                }
            }
            requestAnimationFrame(draw);
        })();
    }
})();
</script>
{% endblock %}
